<div class="review-feedback-panel" [class.disabled]="disabled" [style.max-height]="config.maxHeight">
  <!-- Panel Header -->
  <div class="panel-header">
    <h3>Review Feedback Panel</h3>
    <div class="header-info">
      <div class="selection-summary" *ngIf="hasSelectedReviews">
        <span class="selected-count">{{ selectedCount }} selected</span>
      </div>
      <div class="review-count">
        <span class="total-reviews">{{ availableReviews.length }} reviews</span>
      </div>
    </div>
  </div>

  <!-- Quality Score Display -->
  <div class="quality-score-section" *ngIf="config.showQualityScore && qualityScore">
    <div class="quality-header">
      <h4>Quality Assessment</h4>
      <div class="overall-score" [class.ready]="qualityScore.readyToSave">
        <span class="score-value">{{ qualityScore.overall }}%</span>
        <span class="ready-indicator" *ngIf="qualityScore.readyToSave">‚úÖ Ready to Save</span>
        <span class="needs-work-indicator" *ngIf="!qualityScore.readyToSave">‚ö†Ô∏è Needs Work</span>
      </div>
    </div>
    
    <div class="category-scores">
      <div class="score-item" *ngFor="let category of ['grammar', 'style', 'consistency', 'flow', 'character', 'plot']">
        <span class="category-name">{{ category | titlecase }}</span>
        <div class="score-bar">
          <div class="score-fill" [style.width.%]="getCategoryScore(category)"></div>
          <span class="score-text">{{ getCategoryScore(category) }}%</span>
        </div>
      </div>
    </div>

    <div class="improvements" *ngIf="qualityScore.improvements.length > 0">
      <h5>Top Improvements:</h5>
      <ul>
        <li *ngFor="let improvement of qualityScore.improvements.slice(0, 3)">{{ improvement }}</li>
      </ul>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner">‚è≥</div>
    <span>Loading reviews...</span>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !isLoading">
    <div class="error-icon">‚ö†Ô∏è</div>
    <span>{{ error }}</span>
    <button class="retry-button" (click)="error = null">Dismiss</button>
  </div>

  <!-- Main Content -->
  <div class="panel-content" *ngIf="!isLoading && !error">
    
    <!-- Comprehensive Review Request -->
    <div class="comprehensive-section" *ngIf="config.showRequestButtons">
      <div class="comprehensive-header">
        <h4>Get All Reviews</h4>
        <div class="request-progress" *ngIf="isRequestingComprehensive">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="requestProgress"></div>
          </div>
          <span class="progress-text">{{ requestStatus.completedCount }}/{{ requestStatus.totalRequests }}</span>
        </div>
      </div>
      
      <div class="comprehensive-options">
        <label class="option-checkbox">
          <input type="checkbox" 
                 [(ngModel)]="comprehensiveOptions.includeCharacters"
                 [disabled]="disabled || isRequestingComprehensive">
          <span class="checkmark"></span>
          Characters ({{ availableCharacters.length }})
        </label>
        <label class="option-checkbox">
          <input type="checkbox" 
                 [(ngModel)]="comprehensiveOptions.includeRaters"
                 [disabled]="disabled || isRequestingComprehensive">
          <span class="checkmark"></span>
          Raters ({{ availableRaters.length }})
        </label>
        <label class="option-checkbox">
          <input type="checkbox" 
                 [(ngModel)]="comprehensiveOptions.includeEditor"
                 [disabled]="disabled || isRequestingComprehensive">
          <span class="checkmark"></span>
          Editor
        </label>
      </div>
      
      <button class="primary-button get-all-reviews"
              (click)="requestComprehensiveReviews()"
              [disabled]="disabled || isRequestingComprehensive || (!comprehensiveOptions.includeCharacters && !comprehensiveOptions.includeRaters && !comprehensiveOptions.includeEditor)"
              [class.loading]="isRequestingComprehensive">
        <span *ngIf="!isRequestingComprehensive">Get All Reviews</span>
        <span *ngIf="isRequestingComprehensive">
          <span class="spinner">‚è≥</span> Requesting Reviews...
        </span>
      </button>
    </div>

    <!-- Global Actions -->
    <div class="global-actions">
      <div class="selection-actions">
        <button class="action-button select-all" 
                (click)="selectAllReviews()"
                [disabled]="disabled || availableReviews.length === 0"
                title="Select all reviews">
          Select All
        </button>
        <button class="action-button clear-all" 
                (click)="clearAllSelection()"
                [disabled]="disabled || !hasSelectedReviews"
                title="Clear all selections">
          Clear All
        </button>
      </div>
      
      <div class="priority-actions">
        <button class="priority-button high" 
                (click)="selectByPriority('high')"
                [disabled]="disabled || reviewsByPriority.high.length === 0"
                title="Select high priority reviews">
          üî¥ High ({{ reviewsByPriority.high.length }})
        </button>
        <button class="priority-button medium" 
                (click)="selectByPriority('medium')"
                [disabled]="disabled || reviewsByPriority.medium.length === 0"
                title="Select medium priority reviews">
          üü° Medium ({{ reviewsByPriority.medium.length }})
        </button>
        <button class="priority-button low" 
                (click)="selectByPriority('low')"
                [disabled]="disabled || reviewsByPriority.low.length === 0"
                title="Select low priority reviews">
          üü¢ Low ({{ reviewsByPriority.low.length }})
        </button>
      </div>
    </div>

    <!-- Character Reviews Section -->
    <div class="review-section character-section" *ngIf="characterReviews.length > 0">
      <div class="section-header" (click)="toggleCharacterSection()" (keyup.enter)="toggleCharacterSection()" (keyup.space)="toggleCharacterSection()" tabindex="0">
        <span class="section-toggle" [class.collapsed]="!showCharacterSection">‚ñº</span>
        <span class="section-icon">üë§</span>
        <h4>Character Reviews</h4>
        <span class="section-count">({{ characterReviews.length }})</span>
        <div class="section-actions" *ngIf="characterReviews.length > 0">
          <button class="mini-button" 
                  (click)="selectCategoryReviews('character'); $event.stopPropagation()"
                  [disabled]="disabled"
                  title="Select all character reviews">
            Select All
          </button>
          <button class="mini-button" 
                  (click)="clearCategorySelection('character'); $event.stopPropagation()"
                  [disabled]="disabled"
                  title="Clear character selections">
            Clear
          </button>
        </div>
      </div>

      <div class="section-content" *ngIf="showCharacterSection">
        <div class="review-items">
          <div *ngFor="let item of characterReviews; trackBy: trackByReviewId"
               class="review-item"
               [class.selected]="selectedReviewIds.has(item.id)"
               [class.high-priority]="item.priority === 'high'"
               [class.medium-priority]="item.priority === 'medium'"
               [class.low-priority]="item.priority === 'low'">
            
            <div class="item-header">
              <label class="checkbox-container">
                <input type="checkbox"
                       [checked]="selectedReviewIds.has(item.id)"
                       (change)="toggleReviewSelection(item.id)"
                       [disabled]="disabled">
                <span class="checkmark"></span>
              </label>
              
              <div class="item-meta">
                <span class="reviewer-name">{{ item.metadata.reviewer }}</span>
                <span class="review-type-icon">{{ getReviewTypeIcon(item.type) }}</span>
                <span class="priority-icon">{{ getPriorityIcon(item.priority) }}</span>
                <span class="status-icon">{{ getReviewStatusIcon(item) }}</span>
              </div>
              
              <div class="item-timestamp">
                {{ formatTimestamp(item.metadata.created) }}
              </div>
            </div>
            
            <div class="item-content">
              <h5 class="item-title">{{ item.title }}</h5>
              <p class="item-description">{{ item.description }}</p>
              <div class="item-suggestion" *ngIf="item.suggestion !== item.description">
                <strong>Suggestion:</strong> {{ item.suggestion }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rater Reviews Section -->
    <div class="review-section rater-section" *ngIf="raterReviews.length > 0">
      <div class="section-header" (click)="toggleRaterSection()" (keyup.enter)="toggleRaterSection()" (keyup.space)="toggleRaterSection()" tabindex="0">
        <span class="section-toggle" [class.collapsed]="!showRaterSection">‚ñº</span>
        <span class="section-icon">‚≠ê</span>
        <h4>Rater Reviews</h4>
        <span class="section-count">({{ raterReviews.length }})</span>
        <div class="section-actions" *ngIf="raterReviews.length > 0">
          <button class="mini-button" 
                  (click)="selectCategoryReviews('rater'); $event.stopPropagation()"
                  [disabled]="disabled"
                  title="Select all rater reviews">
            Select All
          </button>
          <button class="mini-button" 
                  (click)="clearCategorySelection('rater'); $event.stopPropagation()"
                  [disabled]="disabled"
                  title="Clear rater selections">
            Clear
          </button>
        </div>
      </div>

      <div class="section-content" *ngIf="showRaterSection">
        <div class="review-items">
          <div *ngFor="let item of raterReviews; trackBy: trackByReviewId"
               class="review-item"
               [class.selected]="selectedReviewIds.has(item.id)"
               [class.high-priority]="item.priority === 'high'"
               [class.medium-priority]="item.priority === 'medium'"
               [class.low-priority]="item.priority === 'low'">
            
            <div class="item-header">
              <label class="checkbox-container">
                <input type="checkbox"
                       [checked]="selectedReviewIds.has(item.id)"
                       (change)="toggleReviewSelection(item.id)"
                       [disabled]="disabled">
                <span class="checkmark"></span>
              </label>
              
              <div class="item-meta">
                <span class="reviewer-name">{{ item.metadata.reviewer }}</span>
                <span class="review-type-icon">{{ getReviewTypeIcon(item.type) }}</span>
                <span class="priority-icon">{{ getPriorityIcon(item.priority) }}</span>
                <span class="status-icon">{{ getReviewStatusIcon(item) }}</span>
              </div>
              
              <div class="item-timestamp">
                {{ formatTimestamp(item.metadata.created) }}
              </div>
            </div>
            
            <div class="item-content">
              <h5 class="item-title">{{ item.title }}</h5>
              <p class="item-description">{{ item.description }}</p>
              <div class="item-suggestion" *ngIf="item.suggestion !== item.description">
                <strong>Suggestion:</strong> {{ item.suggestion }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Editor Reviews Section -->
    <div class="review-section editor-section" *ngIf="editorReviews.length > 0">
      <div class="section-header" (click)="toggleEditorSection()" (keyup.enter)="toggleEditorSection()" (keyup.space)="toggleEditorSection()" tabindex="0">
        <span class="section-toggle" [class.collapsed]="!showEditorSection">‚ñº</span>
        <span class="section-icon">‚úèÔ∏è</span>
        <h4>Editor Reviews</h4>
        <span class="section-count">({{ editorReviews.length }})</span>
        <div class="section-actions" *ngIf="editorReviews.length > 0">
          <button class="mini-button" 
                  (click)="selectCategoryReviews('editor'); $event.stopPropagation()"
                  [disabled]="disabled"
                  title="Select all editor reviews">
            Select All
          </button>
          <button class="mini-button" 
                  (click)="clearCategorySelection('editor'); $event.stopPropagation()"
                  [disabled]="disabled"
                  title="Clear editor selections">
            Clear
          </button>
        </div>
      </div>

      <div class="section-content" *ngIf="showEditorSection">
        <div class="review-items">
          <div *ngFor="let item of editorReviews; trackBy: trackByReviewId"
               class="review-item"
               [class.selected]="selectedReviewIds.has(item.id)"
               [class.high-priority]="item.priority === 'high'"
               [class.medium-priority]="item.priority === 'medium'"
               [class.low-priority]="item.priority === 'low'">
            
            <div class="item-header">
              <label class="checkbox-container">
                <input type="checkbox"
                       [checked]="selectedReviewIds.has(item.id)"
                       (change)="toggleReviewSelection(item.id)"
                       [disabled]="disabled">
                <span class="checkmark"></span>
              </label>
              
              <div class="item-meta">
                <span class="reviewer-name">{{ item.metadata.reviewer }}</span>
                <span class="review-type-icon">{{ getReviewTypeIcon(item.type) }}</span>
                <span class="priority-icon">{{ getPriorityIcon(item.priority) }}</span>
                <span class="status-icon">{{ getReviewStatusIcon(item) }}</span>
              </div>
              
              <div class="item-timestamp">
                {{ formatTimestamp(item.metadata.created) }}
              </div>
            </div>
            
            <div class="item-content">
              <h5 class="item-title">{{ item.title }}</h5>
              <p class="item-description">{{ item.description }}</p>
              <div class="item-suggestion" *ngIf="item.suggestion !== item.description">
                <strong>Suggestion:</strong> {{ item.suggestion }}
              </div>
              <div class="affected-text" *ngIf="item.affectedText">
                <div class="original-text">
                  <strong>Original:</strong> "{{ item.affectedText.originalText }}"
                </div>
                <div class="suggested-text">
                  <strong>Suggested:</strong> "{{ item.affectedText.suggestedText }}"
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overall Empty State -->
    <div class="empty-state overall-empty" *ngIf="availableReviews.length === 0 && !config.showRequestButtons">
      <div class="empty-icon">üí¨</div>
      <h4>No Reviews Available</h4>
      <p>Request comprehensive reviews to see feedback from all agents here.</p>
    </div>

    <!-- Empty State with Request Button -->
    <div class="empty-state with-request" *ngIf="availableReviews.length === 0 && config.showRequestButtons">
      <div class="empty-icon">üîç</div>
      <h4>Ready for Review</h4>
      <p>Click "Get All Reviews" above to request comprehensive feedback from all agents.</p>
    </div>
  </div>

  <!-- Chat Integration Section -->
  <div class="chat-integration" *ngIf="config.showChatIntegration && hasSelectedReviews">
    <div class="chat-section-header">
      <h4>Apply Selected Reviews</h4>
      <span class="selected-indicator">{{ selectedCount }} review{{ selectedCount !== 1 ? 's' : '' }} selected</span>
    </div>
    
    <div class="comment-input">
      <textarea [(ngModel)]="userComment"
                placeholder="Add your instructions for applying these reviews (optional)..."
                rows="3"
                [disabled]="disabled"
                class="user-comment"></textarea>
    </div>
    
    <div class="chat-actions">
      <button class="primary-button apply-selected"
              (click)="addSelectedToChat()"
              [disabled]="disabled || !hasSelectedReviews"
              title="Apply selected reviews via chat">
        Apply Selected Reviews
      </button>
    </div>
  </div>
</div>
