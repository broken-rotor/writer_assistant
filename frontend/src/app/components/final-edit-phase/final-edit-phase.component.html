<div class="final-edit-phase">
  <!-- Phase Header -->
  <div class="phase-header">
    <div class="phase-title">
      <h2>Final Edit & Review</h2>
      <p class="phase-description">Apply reviews and finalize your chapter</p>
    </div>
    
    <!-- Quality Assessment Summary -->
    <div class="quality-summary" *ngIf="qualityAssessment">
      <div class="quality-score" [style.color]="getReadinessColor()">
        <span class="score">{{ qualityAssessment.overallScore }}%</span>
        <span class="label">{{ getReadinessLabel() }}</span>
      </div>
      <button 
        class="toggle-details-btn" 
        (click)="toggleQualityDetails()"
        [class.active]="showQualityDetails">
        {{ showQualityDetails ? 'Hide' : 'Show' }} Details
      </button>
    </div>
  </div>

  <!-- Quality Assessment Details -->
  <div class="quality-details" *ngIf="showQualityDetails && qualityAssessment">
    <div class="quality-categories">
      <div class="category">
        <span class="category-name">Character Consistency</span>
        <div class="score-bar">
          <div class="score-fill" [style.width.%]="qualityAssessment.categoryScores.characterConsistency"></div>
        </div>
        <span class="score-value">{{ qualityAssessment.categoryScores.characterConsistency }}%</span>
      </div>
      <div class="category">
        <span class="category-name">Narrative Flow</span>
        <div class="score-bar">
          <div class="score-fill" [style.width.%]="qualityAssessment.categoryScores.narrativeFlow"></div>
        </div>
        <span class="score-value">{{ qualityAssessment.categoryScores.narrativeFlow }}%</span>
      </div>
      <div class="category">
        <span class="category-name">Literary Quality</span>
        <div class="score-bar">
          <div class="score-fill" [style.width.%]="qualityAssessment.categoryScores.literaryQuality"></div>
        </div>
        <span class="score-value">{{ qualityAssessment.categoryScores.literaryQuality }}%</span>
      </div>
      <div class="category">
        <span class="category-name">Genre Specific</span>
        <div class="score-bar">
          <div class="score-fill" [style.width.%]="qualityAssessment.categoryScores.genreSpecific"></div>
        </div>
        <span class="score-value">{{ qualityAssessment.categoryScores.genreSpecific }}%</span>
      </div>
    </div>

    <div class="quality-feedback" *ngIf="qualityAssessment.improvementAreas.length > 0 || qualityAssessment.strengths.length > 0">
      <div class="improvement-areas" *ngIf="qualityAssessment.improvementAreas.length > 0">
        <h4>Areas for Improvement</h4>
        <ul>
          <li *ngFor="let area of qualityAssessment.improvementAreas">{{ area }}</li>
        </ul>
      </div>
      <div class="strengths" *ngIf="qualityAssessment.strengths.length > 0">
        <h4>Strengths</h4>
        <ul>
          <li *ngFor="let strength of qualityAssessment.strengths">{{ strength }}</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Left Panel: Chapter Content -->
    <div class="chapter-panel">
      <!-- Chapter Analytics -->
      <div class="chapter-analytics">
        <div class="analytics-item">
          <span class="label">Word Count:</span>
          <span class="value">{{ chapterAnalytics.wordCount }}</span>
        </div>
        <div class="analytics-item">
          <span class="label">Reading Time:</span>
          <span class="value">{{ chapterAnalytics.readingTime }} min</span>
        </div>
        <div class="analytics-item">
          <span class="label">Revisions:</span>
          <span class="value">{{ getTotalRevisionsCount() }}</span>
        </div>
        <div class="analytics-item">
          <span class="label">Applied Reviews:</span>
          <span class="value">{{ getAppliedReviewsCount() }}</span>
        </div>
      </div>

      <!-- Chapter Content Display -->
      <div class="chapter-content">
        <div class="content-header">
          <h3>{{ getCurrentRevision()?.title || chapterTitleFromPhase2 }}</h3>
          <div class="content-controls">
            <button 
              class="toggle-btn" 
              (click)="toggleChapterPreview()"
              [class.active]="showChapterPreview">
              {{ showChapterPreview ? 'Hide' : 'Show' }} Preview
            </button>
            <button 
              class="toggle-btn" 
              (click)="toggleRevisionHistory()"
              [class.active]="showRevisionHistory">
              History
            </button>
          </div>
        </div>

        <div class="content-display" *ngIf="showChapterPreview">
          <div class="chapter-text" [innerHTML]="(getCurrentRevision()?.content || chapterDraftFromPhase2) | newlineToBr"></div>
        </div>
      </div>

      <!-- Revision History Panel -->
      <div class="revision-history" *ngIf="showRevisionHistory">
        <h4>Revision History</h4>
        <div class="revision-list">
          <div 
            *ngFor="let revision of revisions" 
            class="revision-item"
            [class.active]="revision.id === currentRevisionId">
            <div class="revision-header">
              <span class="revision-name">{{ revision.name }}</span>
              <span class="revision-date">{{ revision.created | date:'short' }}</span>
            </div>
            <div class="revision-details">
              <p class="changes-summary">{{ revision.changesSummary }}</p>
              <div class="revision-stats">
                <span class="word-count">{{ revision.wordCount }} words</span>
                <span class="applied-reviews" *ngIf="revision.appliedReviews.length > 0">
                  {{ revision.appliedReviews.length }} reviews applied
                </span>
              </div>
            </div>
            <div class="revision-actions">
              <button 
                class="action-btn" 
                (click)="selectRevision(revision.id)"
                [disabled]="revision.id === currentRevisionId">
                Select
              </button>
              <button 
                class="action-btn" 
                (click)="compareRevisions(revision.id)"
                [disabled]="revision.id === currentRevisionId">
                Compare
              </button>
              <button 
                class="action-btn" 
                (click)="rollbackToRevision(revision.id)"
                [disabled]="revision.id === currentRevisionId">
                Rollback
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel: Reviews and Chat -->
    <div class="interaction-panel">
      <!-- Review Feedback Panel -->
      <div class="review-section">
        <h4>Review Feedback</h4>
        <app-review-feedback-panel
          [config]="reviewConfig"
          [story]="story"
          [disabled]="isProcessingRevision"
          (selectionChanged)="onReviewSelectionChanged($event)"
          (reviewRequested)="onReviewRequested($event)"
          (addToChat)="onAddToChat($event)">
        </app-review-feedback-panel>
      </div>

      <!-- Chat Interface -->
      <div class="chat-section">
        <h4>Final Edit Chat</h4>
        <app-chat-interface
          [config]="chatConfig"
          [disabled]="isProcessingRevision"
          [processing]="isProcessingRevision"
          (messageSent)="onMessageSent($event)"
          (messageAction)="onMessageAction($event)">
        </app-chat-interface>
      </div>
    </div>
  </div>

  <!-- Finalization Section -->
  <div class="finalization-section">
    <div class="finalization-header">
      <h3>Chapter Finalization</h3>
      <p class="finalization-description">Review the checklist below and finalize your chapter when ready.</p>
    </div>

    <!-- Finalization Checklist -->
    <div class="finalization-checklist">
      <div class="checklist-item" [class.completed]="finalizationChecks.hasAppliedReviews">
        <span class="checkbox">{{ finalizationChecks.hasAppliedReviews ? '✓' : '○' }}</span>
        <span class="item-text">Applied at least one review suggestion</span>
      </div>
      <div class="checklist-item" [class.completed]="finalizationChecks.qualityThresholdMet">
        <span class="checkbox">{{ finalizationChecks.qualityThresholdMet ? '✓' : '○' }}</span>
        <span class="item-text">Quality score meets threshold (70%+)</span>
      </div>
      <div class="checklist-item" [class.completed]="finalizationChecks.userConfirmed">
        <span class="checkbox">{{ finalizationChecks.userConfirmed ? '✓' : '○' }}</span>
        <span class="item-text">Ready to save and move to next chapter</span>
        <label class="confirmation-checkbox">
          <input 
            type="checkbox" 
            [(ngModel)]="finalizationChecks.userConfirmed"
            (change)="updateFinalizationStatus()">
          <span class="checkmark"></span>
        </label>
      </div>
    </div>

    <!-- Finalization Actions -->
    <div class="finalization-actions">
      <div class="finalization-status">
        <span class="status-text" [class.ready]="canFinalize">
          {{ canFinalize ? 'Ready to finalize' : 'Complete checklist to finalize' }}
        </span>
        <div class="progress-indicator">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
          </div>
          <span class="progress-text">{{ getProgressPercentage() }}% Complete</span>
        </div>
      </div>

      <button 
        class="finalize-btn"
        [disabled]="!canFinalize || isFinalizingChapter"
        (click)="finalizeChapter()">
        <span *ngIf="!isFinalizingChapter">Finalize Chapter</span>
        <span *ngIf="isFinalizingChapter">Finalizing...</span>
      </button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isProcessingRevision">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Processing revision...</p>
    </div>
  </div>
</div>

