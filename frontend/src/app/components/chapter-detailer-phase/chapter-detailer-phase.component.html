<div class="chapter-detailer-phase">
  <!-- Phase Header -->
  <div class="phase-header">
    <h2>âœï¸ Chapter Detailer Phase</h2>
    <div class="phase-progress">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getCompletionPercentage()"></div>
      </div>
      <span class="progress-text">{{ getCompletionPercentage() }}% Complete</span>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="phase-content" [class.with-chat]="showChat" [class.with-feedback]="showFeedbackSidebar">
    
    <!-- Left Panel: Chapter Development -->
    <div class="chapter-panel">
      
      <!-- Chapter Outline Reference (Read-Only) -->
      <div class="section chapter-outline-reference">
        <div class="section-header" (click)="toggleOutlineDetails()" (keyup.enter)="toggleOutlineDetails()" (keyup.space)="toggleOutlineDetails()" tabindex="0">
          <h3>ğŸ“‹ Chapter Outline Reference</h3>
          <span class="toggle-icon">{{ showOutlineDetails ? 'â–¼' : 'â–¶' }}</span>
          <span class="item-count">({{ getOutlineItemsCount() }} items)</span>
        </div>
        
        <div class="outline-summary" *ngIf="!showOutlineDetails && plotOutlineSummary">
          <p class="summary-text">{{ plotOutlineSummary }}</p>
        </div>
        
        <div class="outline-details" *ngIf="showOutlineDetails">
          <!-- Current Chapter Details -->
          <div class="current-chapter-details" *ngIf="currentChapter">
            <div class="chapter-info">
              <div class="item-header">
                <h4 class="item-title">{{ currentChapter.title }}</h4>
                <span class="item-type">Chapter {{ currentChapter.number }}</span>
              </div>
              <p class="item-description" *ngIf="currentChapter.plotPoint">{{ currentChapter.plotPoint }}</p>
              <div class="item-key-plot-items" *ngIf="currentChapter.keyPlotItems && currentChapter.keyPlotItems.length > 0">
                <span class="key-plot-items-label">ğŸ¯ Key Plot Items:</span>
                <ul class="key-plot-items-list">
                  <li class="key-plot-item" *ngFor="let plotItem of currentChapter.keyPlotItems">{{ plotItem }}</li>
                </ul>
              </div>
            </div>
          </div>
          
          <!-- Outline Items for Reference -->
          <div class="outline-items" *ngIf="plotOutlineItems.length > 0">
            <div class="outline-item" *ngFor="let item of plotOutlineItems">
              <div class="item-header">
                <h4 class="item-title">{{ item.title }}</h4>
                <span class="item-type">{{ item.type }}</span>
              </div>
              <p class="item-description">{{ item.description }}</p>
              <div class="item-characters" *ngIf="item.involved_characters && item.involved_characters.length > 0">
                <span class="characters-label">ğŸ‘¥ Characters:</span>
                <span class="character-tag" *ngFor="let character of item.involved_characters">{{ character }}</span>
              </div>
            </div>
          </div>
          <div class="empty-outline" *ngIf="plotOutlineItems.length === 0">
            <p>No chapter outline items available from Story Outline.</p>
          </div>
        </div>
      </div>

      <!-- Chapter Draft Versions -->
      <div class="section chapter-versions-section">
        <div class="section-header">
          <h3>ğŸ“ Chapter Drafts</h3>
          <div class="version-controls">
            <select 
              [(ngModel)]="currentVersionId" 
              (ngModelChange)="switchToVersion($event)"
              class="version-selector"
              *ngIf="draftVersions.length > 0">
              <option *ngFor="let version of draftVersions" [value]="version.id">
                {{ getVersionDisplayName(version) }}
              </option>
            </select>
          </div>
        </div>

        <!-- Current Version Display -->
        <div class="current-version" *ngIf="getCurrentVersion() as currentVersion">
          <div class="version-meta">
            <div class="meta-item">
              <span class="meta-label">Title:</span>
              <span class="meta-value">{{ currentVersion.title }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Word Count:</span>
              <span class="meta-value">{{ formatWordCount(currentVersion.wordCount) }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Created:</span>
              <span class="meta-value">{{ formatDate(currentVersion.created) }}</span>
            </div>
            <div class="meta-item" *ngIf="currentVersion.incorporatedFeedback.length > 0">
              <span class="meta-label">Feedback:</span>
              <span class="meta-value">{{ currentVersion.incorporatedFeedback.length }} items incorporated</span>
            </div>
          </div>
          
          <div class="version-content">
            <div class="content-preview" [innerHTML]="currentVersion.content | newlineToBr"></div>
          </div>
        </div>

        <!-- No Versions State -->
        <div class="no-versions" *ngIf="draftVersions.length === 0">
          <div class="empty-icon">ğŸ“„</div>
          <h4>No chapter drafts yet</h4>
          <p>Generate your initial chapter from the chapter outline or start writing in the chat.</p>
          <button 
            class="primary-button" 
            (click)="generateInitialChapter()" 
            [disabled]="isGeneratingChapter || plotOutlineItems.length === 0">
            <span *ngIf="!isGeneratingChapter">ğŸ¤– Generate Initial Chapter</span>
            <span *ngIf="isGeneratingChapter">â³ Generating...</span>
          </button>
        </div>

        <!-- Chapter Actions -->
        <div class="chapter-actions" *ngIf="getCurrentVersion()">
          <button 
            class="secondary-button" 
            (click)="continueWriting()" 
            [disabled]="isContinuingChapter">
            <span *ngIf="!isContinuingChapter">â• Continue Writing</span>
            <span *ngIf="isContinuingChapter">â³ Continuing...</span>
          </button>
          
          <button 
            class="secondary-button" 
            (click)="toggleWordCountSettings()">
            ğŸ¯ Word Count: {{ formatWordCount(getCurrentWordCount()) }}/{{ formatWordCount(targetWordCount) }}
          </button>
        </div>

        <!-- Word Count Settings -->
        <div class="word-count-settings" *ngIf="showWordCountSettings">
          <div class="settings-header">
            <h4>Word Count Target</h4>
            <button class="close-button" (click)="toggleWordCountSettings()">âœ•</button>
          </div>
          <div class="settings-content">
            <div class="input-group">
              <label for="targetWordCount">Target Word Count:</label>
              <input 
                type="number" 
                id="targetWordCount"
                [(ngModel)]="targetWordCount" 
                (ngModelChange)="updateTargetWordCount($event)"
                min="100" 
                max="10000" 
                step="100"
                class="word-count-input">
            </div>
            <div class="progress-display">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getWordCountProgress()"></div>
              </div>
              <span class="progress-text">{{ getWordCountProgress().toFixed(1) }}% of target</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Phase Completion Status -->
      <div class="section completion-status-section">
        <h3>Phase Completion</h3>
        <div class="completion-checklist">
          <div class="checklist-item" [class.complete]="completionCriteria.hasInitialDraft">
            <span class="check-icon">{{ completionCriteria.hasInitialDraft ? 'âœ…' : 'â³' }}</span>
            <span class="check-text">Initial chapter draft created</span>
          </div>
          <div class="checklist-item" [class.complete]="completionCriteria.meetsMinWordCount">
            <span class="check-icon">{{ completionCriteria.meetsMinWordCount ? 'âœ…' : 'â³' }}</span>
            <span class="check-text">Meets minimum word count ({{ formatWordCount(getCurrentWordCount()) }}/{{ formatWordCount(Math.min(targetWordCount * 0.8, 1000)) }})</span>
          </div>
          <div class="checklist-item" [class.complete]="completionCriteria.hasFeedbackIncorporated">
            <span class="check-icon">{{ completionCriteria.hasFeedbackIncorporated ? 'âœ…' : 'â³' }}</span>
            <span class="check-text">Feedback incorporated from characters/raters</span>
          </div>
          <div class="checklist-item" [class.complete]="completionCriteria.hasReviewedContent">
            <span class="check-icon">{{ completionCriteria.hasReviewedContent ? 'âœ…' : 'â³' }}</span>
            <span class="check-text">Content reviewed and refined</span>
          </div>
        </div>
        
        <div class="completion-message" *ngIf="canAdvancePhase()">
          <div class="success-message">
            ğŸ‰ <strong>Phase Complete!</strong> You can now advance to the Final Edit phase.
          </div>
        </div>
      </div>
    </div>

    <!-- Center Panel: Chat Interface -->
    <div class="chat-panel" *ngIf="showChat">
      <div class="chat-header">
        <h3>ğŸ’¬ Chapter Development Chat</h3>
        <button class="close-button" (click)="toggleChat()" title="Close chat">âœ•</button>
      </div>
      
      <div class="chat-container">
        <app-chat-interface
          [config]="chatConfig"
          [disabled]="false"
          [processing]="isGeneratingChapter || isContinuingChapter || isIncorporatingFeedback"
          (messageSent)="onMessageSent($event)"
          (messageAction)="onMessageAction($event)">
        </app-chat-interface>
      </div>
      
      <!-- Chat Helper -->
      <div class="chat-helper">
        <div class="helper-text">
          ğŸ’¡ <strong>Tips:</strong> Ask for specific scenes, character development, dialogue improvements, or plot refinements. Use "Continue writing" for longer chapters.
        </div>
      </div>
    </div>

    <!-- Right Panel: Feedback Sidebar -->
    <div class="feedback-panel" *ngIf="showFeedbackSidebar">
      <div class="feedback-header">
        <h3>ğŸ“‹ Character & Rater Feedback</h3>
        <button class="close-button" (click)="toggleFeedbackSidebar()" title="Close feedback">âœ•</button>
      </div>
      
      <div class="feedback-container">
        <app-feedback-sidebar
          [config]="feedbackConfig"
          [story]="story"
          (feedbackSelectionChanged)="onFeedbackSelectionChanged($event)"
          (addToChat)="onAddFeedbackToChat($event)">
        </app-feedback-sidebar>
      </div>
      
      <!-- Feedback Helper -->
      <div class="feedback-helper">
        <div class="helper-text">
          ğŸ’¡ <strong>Workflow:</strong> Request feedback from characters and raters, then select relevant items to incorporate into your chapter via chat.
        </div>
        <div class="selected-count" *ngIf="selectedFeedbackItems.length > 0">
          {{ selectedFeedbackItems.length }} feedback item(s) selected
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Toggle Buttons -->
  <div class="mobile-toggles">
    <button 
      class="toggle-button" 
      [class.active]="showChat"
      (click)="toggleChat()">
      ğŸ’¬ Chat
    </button>
    <button 
      class="toggle-button" 
      [class.active]="showFeedbackSidebar"
      (click)="toggleFeedbackSidebar()">
      ğŸ“‹ Feedback
    </button>
  </div>
</div>
