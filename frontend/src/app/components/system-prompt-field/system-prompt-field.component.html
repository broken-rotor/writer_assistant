<div [class]="getComponentClasses().join(' ')">
  <!-- Label -->
  <label 
    *ngIf="label" 
    [for]="getTextareaId()" 
    class="system-prompt-field__label">
    {{ label }}
    <span *ngIf="required" class="system-prompt-field__required" aria-label="required">*</span>
  </label>

  <!-- Textarea Input -->
  <div class="system-prompt-field__input-container">
    <textarea
      [id]="getTextareaId()"
      [class]="getTextareaClasses().join(' ')"
      [placeholder]="placeholder"
      [rows]="rows"
      [disabled]="disabled"
      [required]="required"
      [value]="value"
      [attr.aria-describedby]="getAriaDescribedBy()"
      [attr.aria-invalid]="hasError"
      (input)="onInputChange($event)"
      (blur)="onBlur()">
    </textarea>

    <!-- Loading Indicator -->
    <div 
      *ngIf="isLoading || isRetrying" 
      class="system-prompt-field__loading"
      [class.system-prompt-field__loading--retrying]="isRetrying"
      aria-live="polite">
      <span class="system-prompt-field__loading-spinner"></span>
      <span class="system-prompt-field__loading-text">{{ getStatusMessage() }}</span>
    </div>
  </div>

  <!-- Token Counter -->
  <div 
    *ngIf="shouldShowTokenCounter()" 
    class="system-prompt-field__counter-container"
    [id]="getTextareaId() + '-counter'">
    <app-token-counter
      [data]="tokenCounterData"
      [config]="{ displayMode: DisplayMode.COMPACT, showProgressBar: true }"
      [loading]="isLoading">
    </app-token-counter>
  </div>

  <!-- Validation Message -->
  <div 
    *ngIf="shouldShowValidationMessage()" 
    class="system-prompt-field__validation"
    [id]="getTextareaId() + '-validation'"
    [attr.aria-live]="validationResult?.status === ValidationStatus.ERROR ? 'assertive' : 'polite'"
    role="alert">
    
    <span class="system-prompt-field__validation-icon">
      {{ ValidationUtils.getStatusIcon(validationResult!.status) }}
    </span>
    
    <span class="system-prompt-field__validation-message">
      {{ validationResult!.message }}
    </span>
    
    <!-- Excess tokens warning for invalid status -->
    <span 
      *ngIf="validationResult?.status === ValidationStatus.INVALID && validationResult?.metadata?.excessTokens" 
      class="system-prompt-field__excess-tokens">
      ({{ validationResult?.metadata?.excessTokens }} tokens over limit)
    </span>
  </div>

  <!-- Error Message with Recovery Actions -->
  <div 
    *ngIf="hasError && errorMessage" 
    class="system-prompt-field__error"
    role="alert"
    aria-live="assertive">
    <div class="system-prompt-field__error-content">
      <span class="system-prompt-field__error-icon">âš ï¸</span>
      <span class="system-prompt-field__error-message">{{ errorMessage }}</span>
    </div>
    
    <!-- Recovery Actions -->
    <div class="system-prompt-field__error-actions" *ngIf="canRetry()">
      <button 
        type="button"
        class="system-prompt-field__retry-button"
        (click)="retryValidation()"
        [disabled]="isRetrying"
        aria-label="Retry token validation">
        <span *ngIf="!isRetrying">ğŸ”„ Retry</span>
        <span *ngIf="isRetrying">â³ Retrying...</span>
      </button>
      
      <button 
        type="button"
        class="system-prompt-field__fallback-button"
        (click)="useFallbackMode()"
        aria-label="Use default token limits">
        ğŸ“Š Use Defaults
      </button>
    </div>
  </div>

  <!-- Fallback Mode Indicator -->
  <div 
    *ngIf="isFallbackMode && !hasError" 
    class="system-prompt-field__fallback-indicator"
    role="status"
    aria-live="polite">
    <span class="system-prompt-field__fallback-icon">ğŸ“Š</span>
    <span class="system-prompt-field__fallback-text">Using default token limits</span>
  </div>

  <!-- Help Text -->
  <div 
    *ngIf="!isLoading && !hasError && !isFallbackMode && validationResult?.status === ValidationStatus.VALID" 
    class="system-prompt-field__help">
    <small class="system-prompt-field__help-text">
      Field type: {{ fieldType }} â€¢ Updates automatically as you type
    </small>
  </div>
</div>
