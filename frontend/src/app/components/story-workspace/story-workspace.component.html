<!-- Global Loading Spinner -->
<app-loading-spinner></app-loading-spinner>

<!-- Toast Notifications -->
<app-toast></app-toast>

<div class="story-workspace" *ngIf="!loading && !error && story">
  <!-- Header with Story Title and Last Saved -->
  <div class="workspace-header">
    <h1>{{ story.general.title }}</h1>
    <div class="save-indicator" *ngIf="lastSaved">
      Last saved: {{ lastSaved | date:'short' }}
    </div>
  </div>

  <!-- Token Validation Status -->
  <div class="validation-status" *ngIf="activeTab === 'general'">
    <div class="validation-summary" 
         [class.loading]="tokenLimitsLoading || isTokenLimitsRetrying"
         [class.error]="tokenLimitsError && !isTokenLimitsFallbackMode"
         [class.fallback]="isTokenLimitsFallbackMode"
         [class.invalid]="!canSave() && !tokenLimitsLoading && !isTokenLimitsRetrying">
      <span class="status-icon">
        <span *ngIf="tokenLimitsLoading || isTokenLimitsRetrying">‚è≥</span>
        <span *ngIf="tokenLimitsError && !isTokenLimitsFallbackMode">‚ö†Ô∏è</span>
        <span *ngIf="isTokenLimitsFallbackMode">üìä</span>
        <span *ngIf="!canSave() && !tokenLimitsLoading && !isTokenLimitsRetrying && !tokenLimitsError">üö´</span>
        <span *ngIf="canSave() && !tokenLimitsLoading && !isTokenLimitsRetrying && !tokenLimitsError && !isTokenLimitsFallbackMode">‚úÖ</span>
      </span>
      <span class="status-text">{{ getValidationSummary() }}</span>
      
      <!-- Retry Button -->
      <button 
        *ngIf="canRetryTokenLimits()"
        type="button"
        class="retry-button"
        (click)="retryTokenLimits()"
        [disabled]="isTokenLimitsRetrying"
        aria-label="Retry loading token limits">
        <span *ngIf="!isTokenLimitsRetrying">üîÑ Retry</span>
        <span *ngIf="isTokenLimitsRetrying">‚è≥ Retrying...</span>
      </button>
    </div>
    
    <div class="validation-warning" *ngIf="!canSave() && !tokenLimitsLoading && !isTokenLimitsRetrying">
      <strong>Warning:</strong> Some fields exceed token limits. Auto-save is disabled until limits are met.
    </div>
    
    <div class="validation-fallback" *ngIf="isTokenLimitsFallbackMode">
      <strong>Info:</strong> Using default token limits. The app remains functional with estimated token counts.
    </div>
  </div>

  <!-- Tab Navigation -->
  <nav class="tab-nav">
    <button class="tab-button" [class.active]="activeTab === 'general'" (click)="selectTab('general')">General</button>
    <button class="tab-button" [class.active]="activeTab === 'characters'" (click)="selectTab('characters')">Characters</button>
    <button class="tab-button" [class.active]="activeTab === 'raters'" (click)="selectTab('raters')">Raters</button>
    <button class="tab-button" [class.active]="activeTab === 'story'" (click)="selectTab('story')">Story</button>
    <button class="tab-button" [class.active]="activeTab === 'chapter-creation'" (click)="selectTab('chapter-creation')">Chapter Creation</button>
  </nav>

  <!-- Phase Navigation (shown only for chapter-creation tab) -->
  <app-phase-navigation 
    *ngIf="showPhaseNavigation"
    [chapterNumber]="getCurrentChapterNumber()"
    [chapterTitle]="getCurrentChapterTitle()"
    (phaseChanged)="onPhaseChanged($event)">
  </app-phase-navigation>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- General Tab -->
    <div *ngIf="activeTab === 'general'" class="tab-pane general-tab">
      <h2>General Settings</h2>

      <div class="form-section">
        <label for="story-title">Story Title</label>
        <input id="story-title" type="text" [(ngModel)]="story.general.title" placeholder="Enter story title">
      </div>

      <div class="form-section">
        <app-system-prompt-field
          fieldType="mainPrefix"
          label="Main System Prompt Prefix (optional)"
          placeholder="Text added before every agent prompt"
          [rows]="3"
          [(ngModel)]="story.general.systemPrompts.mainPrefix"
          (validationChange)="onFieldValidationChange('mainPrefix', $event)">
        </app-system-prompt-field>
        <div class="file-upload-section">
          <input type="file" #prefixFileInput accept=".txt,.md" (change)="loadFileContent($event, 'prefix')" style="display: none">
          <button class="secondary-button" (click)="prefixFileInput.click()">Load from File (.txt, .md)</button>
        </div>
      </div>

      <div class="form-section">
        <app-system-prompt-field
          fieldType="mainSuffix"
          label="Main System Prompt Suffix (optional)"
          placeholder="Text added after every agent prompt"
          [rows]="3"
          [(ngModel)]="story.general.systemPrompts.mainSuffix"
          (validationChange)="onFieldValidationChange('mainSuffix', $event)">
        </app-system-prompt-field>
        <div class="file-upload-section">
          <input type="file" #suffixFileInput accept=".txt,.md" (change)="loadFileContent($event, 'suffix')" style="display: none">
          <button class="secondary-button" (click)="suffixFileInput.click()">Load from File (.txt, .md)</button>
        </div>
      </div>

      <div class="form-section">
        <app-system-prompt-field
          fieldType="assistantPrompt"
          label="Writer Assistant System Prompt"
          placeholder="Assistant's system prompt configuration"
          [rows]="5"
          [(ngModel)]="story.general.systemPrompts.assistantPrompt"
          (validationChange)="onFieldValidationChange('assistantPrompt', $event)">
        </app-system-prompt-field>
      </div>

      <div class="form-section">
        <app-system-prompt-field
          fieldType="editorPrompt"
          label="Editor System Prompt"
          placeholder="Editor's system prompt configuration"
          [rows]="5"
          [(ngModel)]="story.general.systemPrompts.editorPrompt"
          (validationChange)="onFieldValidationChange('editorPrompt', $event)">
        </app-system-prompt-field>
      </div>

      <div class="form-section">
        <label for="worldbuilding">Overall Setting / Worldbuilding</label>
        <textarea id="worldbuilding" [(ngModel)]="story.general.worldbuilding" placeholder="User-provided worldbuilding. AI can flesh out, user can edit." rows="10"></textarea>
        <div class="button-group">
          <button class="secondary-button" (click)="aiFleshOutWorldbuilding()">AI Flesh Out</button>
          <button class="secondary-button">Reset to Original</button>
        </div>
      </div>
    </div>

    <!-- Characters Tab -->
    <div *ngIf="activeTab === 'characters'" class="tab-pane characters-tab">
      <h2>Characters</h2>

      <div class="split-panel">
        <!-- Character List -->
        <div class="list-panel">
          <div class="section-header">
            <h3>Active Characters</h3>
            <button class="primary-button" (click)="addCharacter()">+ Add</button>
          </div>

          <div class="character-list">
            <div *ngFor="let character of activeCharacters"
                 class="list-item"
                 [class.selected]="selectedCharacterId === character.id"
                 (click)="selectCharacter(character.id)">
              <div class="item-name">{{ character.name || 'Unnamed' }}</div>
              <div class="item-actions">
                <button class="icon-button" (click)="hideCharacter(character.id); $event.stopPropagation()" title="Hide">üëÅÔ∏è</button>
              </div>
            </div>
          </div>

          <div class="section-header" *ngIf="hiddenCharacters.length > 0">
            <h3>Hidden Characters</h3>
          </div>

          <div class="character-list" *ngIf="hiddenCharacters.length > 0">
            <div *ngFor="let character of hiddenCharacters" class="list-item hidden">
              <div class="item-name">{{ character.name || 'Unnamed' }}</div>
              <div class="item-actions">
                <button class="icon-button" (click)="unhideCharacter(character.id)" title="Unhide">üëÅÔ∏è‚Äçüó®Ô∏è</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Character Details -->
        <div class="detail-panel" *ngIf="editingCharacter">
          <h3>Character Details</h3>

          <div class="form-section">
            <label>Basic Bio (user-provided)</label>
            <textarea [(ngModel)]="editingCharacter.basicBio" placeholder="A curious journalist who..." rows="4"></textarea>
            <button class="secondary-button" (click)="generateCharacterDetails()">Generate from Bio</button>
          </div>

          <div class="form-section">
            <label>Name</label>
            <input type="text" [(ngModel)]="editingCharacter.name" placeholder="Character name">
          </div>

          <div class="form-row">
            <div class="form-section">
              <label>Sex</label>
              <input type="text" [(ngModel)]="editingCharacter.sex" placeholder="Male/Female">
            </div>
            <div class="form-section">
              <label>Gender</label>
              <input type="text" [(ngModel)]="editingCharacter.gender" placeholder="Gender identity">
            </div>
          </div>

          <div class="form-row">
            <div class="form-section">
              <label>Sexual Preference</label>
              <input type="text" [(ngModel)]="editingCharacter.sexualPreference">
            </div>
            <div class="form-section">
              <label>Age</label>
              <input type="number" [(ngModel)]="editingCharacter.age">
            </div>
          </div>

          <div class="form-section">
            <label>Physical Appearance</label>
            <textarea [(ngModel)]="editingCharacter.physicalAppearance" rows="3"></textarea>
          </div>

          <div class="form-section">
            <label>Usual Clothing</label>
            <textarea [(ngModel)]="editingCharacter.usualClothing" rows="2"></textarea>
          </div>

          <div class="form-section">
            <label>Personality</label>
            <textarea [(ngModel)]="editingCharacter.personality" rows="3"></textarea>
          </div>

          <div class="form-section">
            <label>Motivations</label>
            <textarea [(ngModel)]="editingCharacter.motivations" rows="3"></textarea>
          </div>

          <div class="form-section">
            <label>Fears</label>
            <textarea [(ngModel)]="editingCharacter.fears" rows="3"></textarea>
          </div>

          <div class="form-section">
            <label>Relationships</label>
            <textarea [(ngModel)]="editingCharacter.relationships" rows="4"></textarea>
            <button class="secondary-button" (click)="regenerateRelationships()">Regenerate Relationships</button>
          </div>

          <div class="button-group">
            <button class="primary-button" (click)="saveCharacter()">Save</button>
            <button class="danger-button" (click)="removeCharacter(editingCharacter.id)">Delete</button>
          </div>
        </div>

        <div class="detail-panel empty" *ngIf="!editingCharacter">
          <p>Select a character to edit or add a new one.</p>
        </div>
      </div>
    </div>

    <!-- Raters Tab -->
    <div *ngIf="activeTab === 'raters'" class="tab-pane raters-tab">
      <h2>Raters</h2>

      <div class="split-panel">
        <!-- Rater List -->
        <div class="list-panel">
          <div class="section-header">
            <h3>Configured Raters</h3>
            <button class="primary-button" (click)="addRater()">+ Add New Rater</button>
          </div>

          <div class="rater-list">
            <div *ngFor="let rater of ratersArray"
                 class="list-item"
                 [class.selected]="selectedRaterId === rater.id"
                 (click)="selectRater(rater.id)">
              <div class="item-name">{{ rater.name || 'Unnamed Rater' }}</div>
              <div class="item-actions">
                <label class="toggle">
                  <input type="checkbox" [checked]="rater.enabled" (change)="toggleRater(rater.id); $event.stopPropagation()">
                  <span>Enabled</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Rater Details -->
        <div class="detail-panel" *ngIf="editingRater">
          <h3>Rater Configuration</h3>

          <div class="form-section">
            <label>Name</label>
            <input type="text" [(ngModel)]="editingRater.name" placeholder="e.g., Character Consistency Rater">
          </div>

          <div class="form-section">
            <label>System Prompt</label>
            <textarea [(ngModel)]="editingRater.systemPrompt" placeholder="Evaluate character consistency, check for..." rows="10"></textarea>
          </div>

          <div class="button-group">
            <button class="primary-button" (click)="saveRater()">Save</button>
            <button class="danger-button" (click)="removeRater(editingRater.id)">Delete</button>
          </div>
        </div>

        <div class="detail-panel empty" *ngIf="!editingRater">
          <p>Select a rater to edit or add a new one.</p>
        </div>
      </div>
    </div>

    <!-- Story Tab -->
    <div *ngIf="activeTab === 'story'" class="tab-pane story-tab">
      <h2>Story</h2>

      <div class="story-summary">
        <h3>Overall Story Summary</h3>
        <div class="summary-content">
          <p>{{ story.story.summary || 'No summary yet. Generate chapters to create a summary.' }}</p>
        </div>
        <button class="secondary-button" (click)="regenerateSummary()">Regenerate Summary</button>
      </div>

      <div class="chapters-section">
        <div class="section-header">
          <h3>Chapters</h3>
          <button class="primary-button" (click)="addChapterAtEnd()">+ Add Chapter at End</button>
        </div>

        <div class="chapters-list">
          <div *ngFor="let chapter of story.story.chapters; let i = index" class="chapter-item">
            <div class="chapter-header">
              <h4>Chapter {{ chapter.number }}: {{ chapter.title }}</h4>
              <div class="chapter-actions">
                <button class="secondary-button" (click)="editChapter(chapter.id)">Edit</button>
                <button class="secondary-button" (click)="insertChapterAfter(i)">Insert After</button>
                <button class="danger-button" (click)="deleteChapter(chapter.id)">Delete</button>
              </div>
            </div>
            <div class="chapter-preview">
              <p>{{ chapter.content.substring(0, 200) }}...</p>
              <div class="chapter-meta">
                Word count: {{ chapter.metadata.wordCount }} | Last modified: {{ chapter.metadata.lastModified | date:'short' }}
              </div>
            </div>
          </div>

          <div *ngIf="story.story.chapters.length === 0" class="empty-state">
            <p>No chapters yet. Create your first chapter in the Chapter Creation tab!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chapter Creation Tab -->
    <div *ngIf="activeTab === 'chapter-creation'" class="tab-pane chapter-creation-tab">
      <div class="chapter-creation-header">
        <h2>Chapter Creation</h2>
        <div class="chapter-creation-actions">
          <button 
            class="secondary-button feedback-toggle"
            (click)="toggleFeedbackSidebar()"
            [class.active]="showFeedbackSidebar"
            title="Toggle feedback sidebar">
            üí¨ Feedback
          </button>
        </div>
      </div>

      <!-- Three-Phase Chapter Compose Interface -->
      <div *ngIf="currentPhase === 'plot_outline'" class="phase-content">
        <app-plot-outline-phase
          [story]="story"
          [chapterNumber]="getCurrentChapterNumber()"
          (phaseCompleted)="onPlotOutlinePhaseCompleted()"
          (outlineUpdated)="onOutlineUpdated($event)">
        </app-plot-outline-phase>
      </div>

      <div *ngIf="currentPhase === 'final_edit'" class="phase-content">
        <app-final-edit-phase
          [story]="story"
          [chapterNumber]="getCurrentChapterNumber()"
          (phaseCompleted)="onFinalEditPhaseCompleted()"
          (chapterFinalized)="onChapterFinalized($event)">
        </app-final-edit-phase>
      </div>

      <!-- Legacy Chapter Creation Interface (for other phases and backward compatibility) -->
      <div *ngIf="currentPhase !== 'plot_outline' && currentPhase !== 'final_edit'" class="legacy-chapter-creation">
        <!-- Plot Point -->
      <div class="section plot-point-section">
        <h3>Plot Point</h3>
        <textarea [(ngModel)]="story.chapterCreation.plotPoint" placeholder="Sarah discovers a hidden letter in the..." rows="4"></textarea>
        <div class="button-group">
          <button class="secondary-button" (click)="aiFleshOutPlotPoint()">AI Flesh Out</button>
          <button class="secondary-button" (click)="researchPlotPoint()" title="Research similar content from story archive">üìö Research Archive</button>
          <button class="secondary-button">Reset</button>
        </div>
      </div>

      <!-- Incorporated Feedback -->
      <div class="section incorporated-feedback-section">
        <h3>Incorporated Feedback</h3>
        <div class="feedback-list">
          <div *ngFor="let item of story.chapterCreation.incorporatedFeedback; let i = index" class="feedback-item">
            <div class="feedback-content" *ngIf="editingFeedbackIndex !== i">
              <strong>{{ item.source }}</strong> ({{ item.type }}): {{ item.content }}
            </div>
            <div class="feedback-edit-form" *ngIf="editingFeedbackIndex === i">
              <div class="feedback-header-edit">
                <strong>{{ item.source }}</strong> ({{ item.type }})
              </div>
              <textarea [(ngModel)]="editingFeedbackContent" rows="3"></textarea>
              <div class="button-group">
                <button class="secondary-button" (click)="saveFeedbackEdit()">Save</button>
                <button class="secondary-button" (click)="cancelFeedbackEdit()">Cancel</button>
              </div>
            </div>
            <div class="item-actions" *ngIf="editingFeedbackIndex !== i">
              <button class="icon-button" (click)="editFeedbackItem(i)" title="Edit">‚úèÔ∏è</button>
              <button class="icon-button" (click)="removeFeedbackItem(i)" title="Remove">‚úï</button>
            </div>
          </div>
          <div *ngIf="story.chapterCreation.incorporatedFeedback.length === 0" class="empty-state">
            No feedback incorporated yet. Request feedback from characters or raters below.
          </div>
        </div>
      </div>

      <!-- Agent Feedback Panel -->
      <div class="section agent-feedback-section">
        <div class="split-panel">
          <!-- Agent List -->
          <div class="agent-list-panel">
            <h3>Request Feedback</h3>

            <div class="agent-category">
              <h4>Characters</h4>
              <div class="agent-buttons">
                <button *ngFor="let character of activeCharacters"
                        class="agent-button"
                        [class.loading]="generatingFeedback.has(character.id)"
                        [class.selected]="selectedAgentId === character.id"
                        (click)="requestCharacterFeedback(character.id)">
                  {{ character.name }}
                  <span *ngIf="generatingFeedback.has(character.id)" class="spinner">‚è≥</span>
                </button>
                <div *ngIf="activeCharacters.length === 0" class="empty-state">
                  No active characters. Add characters in the Characters tab.
                </div>
              </div>
            </div>

            <div class="agent-category">
              <h4>Raters</h4>
              <div class="agent-buttons">
                <button *ngFor="let rater of enabledRaters"
                        class="agent-button"
                        [class.loading]="generatingFeedback.has(rater.id)"
                        [class.selected]="selectedAgentId === rater.id"
                        (click)="requestRaterFeedback(rater.id)">
                  {{ rater.name }}
                  <span *ngIf="generatingFeedback.has(rater.id)" class="spinner">‚è≥</span>
                </button>
                <div *ngIf="enabledRaters.length === 0" class="empty-state">
                  No enabled raters. Add raters in the Raters tab.
                </div>
              </div>
            </div>
          </div>

          <!-- Feedback Display -->
          <div class="feedback-display-panel">
            <h3>Agent Feedback</h3>

            <div *ngIf="feedbackRequestsArray.length === 0">
              <p class="hint">Click an agent to request feedback. Results will appear here.</p>
            </div>

            <div *ngFor="let feedbackRequest of feedbackRequestsArray" class="feedback-result">
              <div class="feedback-header">
                <h4>{{ getFeedbackName(feedbackRequest.feedback) }}</h4>
              </div>

              <!-- Character Feedback -->
              <div *ngIf="isCharacterFeedback(feedbackRequest.feedback)" class="character-feedback">
                <div class="feedback-section" *ngIf="$any(feedbackRequest.feedback).actions?.length > 0">
                  <strong>Actions:</strong>
                  <ul>
                    <li *ngFor="let action of $any(feedbackRequest.feedback).actions">
                      {{ action }}
                      <button class="incorporate-button" (click)="incorporateFeedback(getFeedbackName(feedbackRequest.feedback), 'action', action)">+</button>
                    </li>
                  </ul>
                </div>

                <div class="feedback-section" *ngIf="$any(feedbackRequest.feedback).dialog?.length > 0">
                  <strong>Dialog:</strong>
                  <ul>
                    <li *ngFor="let line of $any(feedbackRequest.feedback).dialog">
                      "{{ line }}"
                      <button class="incorporate-button" (click)="incorporateFeedback(getFeedbackName(feedbackRequest.feedback), 'dialog', line)">+</button>
                    </li>
                  </ul>
                </div>

                <div class="feedback-section" *ngIf="$any(feedbackRequest.feedback).physicalSensations?.length > 0">
                  <strong>Physical Sensations:</strong>
                  <ul>
                    <li *ngFor="let sensation of $any(feedbackRequest.feedback).physicalSensations">
                      {{ sensation }}
                      <button class="incorporate-button" (click)="incorporateFeedback(getFeedbackName(feedbackRequest.feedback), 'sensation', sensation)">+</button>
                    </li>
                  </ul>
                </div>

                <div class="feedback-section" *ngIf="$any(feedbackRequest.feedback).emotions?.length > 0">
                  <strong>Emotions:</strong>
                  <ul>
                    <li *ngFor="let emotion of $any(feedbackRequest.feedback).emotions">
                      {{ emotion }}
                      <button class="incorporate-button" (click)="incorporateFeedback(getFeedbackName(feedbackRequest.feedback), 'emotion', emotion)">+</button>
                    </li>
                  </ul>
                </div>

                <div class="feedback-section" *ngIf="$any(feedbackRequest.feedback).internalMonologue?.length > 0">
                  <strong>Internal Monologue:</strong>
                  <ul>
                    <li *ngFor="let thought of $any(feedbackRequest.feedback).internalMonologue">
                      {{ thought }}
                      <button class="incorporate-button" (click)="incorporateFeedback(getFeedbackName(feedbackRequest.feedback), 'thought', thought)">+</button>
                    </li>
                  </ul>
                </div>
              </div>

              <!-- Rater Feedback -->
              <div *ngIf="isRaterFeedback(feedbackRequest.feedback)" class="rater-feedback">
                <div class="feedback-section">
                  <strong>Opinion:</strong>
                  <p>{{ $any(feedbackRequest.feedback).opinion }}</p>
                </div>

                <div class="feedback-section" *ngIf="$any(feedbackRequest.feedback).suggestions?.length > 0">
                  <strong>Suggestions:</strong>
                  <ul>
                    <li *ngFor="let suggestion of $any(feedbackRequest.feedback).suggestions">
                      {{ suggestion.suggestion || suggestion }}
                      <button class="incorporate-button" (click)="incorporateFeedback(getFeedbackName(feedbackRequest.feedback), 'suggestion', suggestion.suggestion || suggestion)">+</button>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chapter Generation -->
      <div class="section chapter-generation-section">
        <button class="primary-button large" (click)="generateChapter()" [disabled]="generatingChapter || !story.chapterCreation.plotPoint">
          <span *ngIf="!generatingChapter">Generate Chapter</span>
          <span *ngIf="generatingChapter">Generating... ‚è≥</span>
        </button>
      </div>

      <!-- Generated Chapter -->
      <div class="section generated-chapter-section" *ngIf="story.chapterCreation.generatedChapter">
        <div class="chapter-title-input">
          <input type="text" [(ngModel)]="chapterTitle" placeholder="Chapter Title (optional - will auto-generate if empty)">
        </div>
        <textarea [(ngModel)]="story.chapterCreation.generatedChapter.text" rows="35"></textarea>

        <div class="prompt-changes-section">
          <h4>Prompt Writer for Changes</h4>
          <textarea [(ngModel)]="changeRequest" placeholder="Describe the changes you want (e.g., 'Make the dialogue more tense', 'Add more description of the setting')" rows="3"></textarea>
          <button class="secondary-button" (click)="promptAssistantForChanges()" [disabled]="!changeRequest || generatingChapter">
            <span *ngIf="!generatingChapter">Apply Changes</span>
            <span *ngIf="generatingChapter">Applying... ‚è≥</span>
          </button>
        </div>

        <div class="button-group">
          <button class="secondary-button" (click)="requestEditorReview()" [disabled]="generatingReview">
            <span *ngIf="!generatingReview">Request Editor Review</span>
            <span *ngIf="generatingReview">Reviewing... ‚è≥</span>
          </button>
        </div>

        <!-- Editor Suggestions -->
        <div class="editor-suggestions" *ngIf="story.chapterCreation.editorReview">
          <h4>Editor Suggestions</h4>
          <div class="suggestions-list">
            <div *ngFor="let suggestion of story.chapterCreation.editorReview.suggestions; let i = index" class="suggestion-item">
              <label>
                <input type="checkbox" [(ngModel)]="suggestion.selected">
                <div class="suggestion-content">
                  <span class="priority" [class]="suggestion.priority">{{ suggestion.priority }}</span>
                  <strong>{{ suggestion.issue }}</strong>
                  <p>{{ suggestion.suggestion }}</p>
                </div>
              </label>
            </div>
          </div>
          <div class="button-group">
            <button class="secondary-button" (click)="applyEditorSuggestions(false)" [disabled]="generatingChapter">
              <span *ngIf="!generatingChapter">Apply Selected</span>
              <span *ngIf="generatingChapter">Applying... ‚è≥</span>
            </button>
            <button class="secondary-button" (click)="applyEditorSuggestions(true)" [disabled]="generatingChapter">
              <span *ngIf="!generatingChapter">Apply All</span>
              <span *ngIf="generatingChapter">Applying... ‚è≥</span>
            </button>
          </div>
        </div>

        <button class="primary-button large" (click)="acceptChapter()">Accept Chapter - Add to Story</button>
      </div>
      </div> <!-- End legacy-chapter-creation -->
    </div>
  </div>

  <!-- Research Archive Sidebar -->
  <div class="research-sidebar" *ngIf="showResearchSidebar" [class.show]="showResearchSidebar">
    <div class="sidebar-header">
      <h3>üìö Archive Research</h3>
      <div class="header-actions">
        <button class="icon-button-header" (click)="clearResearchChat()" *ngIf="researchChatHistory.length > 0" title="Clear conversation">üóëÔ∏è</button>
        <button class="close-button" (click)="closeResearchSidebar()" title="Close">‚úï</button>
      </div>
    </div>

    <div class="sidebar-content">
      <!-- Initial Loading State -->
      <div class="research-loading" *ngIf="researchLoading && researchChatHistory.length === 0">
        <div class="spinner"></div>
        <p>Researching your story archive...</p>
      </div>

      <!-- Error State (when no conversation yet) -->
      <div class="research-error" *ngIf="researchError && researchChatHistory.length === 0">
        <span class="error-icon">‚ö†Ô∏è</span>
        <p>{{ researchError }}</p>
      </div>

      <!-- Chat History -->
      <div class="research-chat-history" *ngIf="researchChatHistory.length > 0">
        <div *ngFor="let message of researchChatHistory; let i = index"
             class="chat-message"
             [ngClass]="'chat-message-' + message.role">

          <!-- User Message -->
          <div *ngIf="message.role === 'user'" class="message-bubble user-bubble">
            <div class="message-label">You asked:</div>
            <div class="message-text">{{ message.content }}</div>
          </div>

          <!-- Assistant Message -->
          <div *ngIf="message.role === 'assistant'" class="message-bubble assistant-bubble">
            <div class="message-label">Research Assistant:</div>
            <div class="message-text" [innerHTML]="message.content | newlineToBr"></div>

            <!-- Sources for this response -->
            <div class="message-sources" *ngIf="message.sources && message.sources.length > 0">
              <div class="sources-toggle" (click)="message.showSources = !message.showSources">
                <span>üìñ {{ message.sources.length }} sources</span>
                <span class="toggle-icon">{{ message.showSources ? '‚ñº' : '‚ñ∂' }}</span>
              </div>
              <div class="sources-list" *ngIf="message.showSources">
                <div class="source-item-compact" *ngFor="let source of message.sources">
                  <span class="source-file-compact">{{ getSourceFileName(source) }}</span>
                  <span class="similarity-badge-compact" [ngClass]="getSimilarityClass(source.similarity_score)">
                    {{ source.similarity_score | number:'1.2-2' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Typing Indicator -->
        <div class="chat-message chat-message-assistant" *ngIf="researchLoading">
          <div class="message-bubble assistant-bubble typing-bubble">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>

        <!-- Error in conversation -->
        <div class="inline-error" *ngIf="researchError && researchChatHistory.length > 0">
          <span class="error-icon">‚ö†Ô∏è</span>
          <span>{{ researchError }}</span>
        </div>
      </div>

      <!-- Latest Sources Panel (expanded view) -->
      <div class="research-sources-panel" *ngIf="researchData && researchData.sources && researchData.sources.length > 0">
        <h4>üìñ Latest Sources</h4>
        <div class="sources-list-detailed">
          <div class="source-item" *ngFor="let source of researchData.sources">
            <div class="source-header">
              <span class="source-file">{{ getSourceFileName(source) }}</span>
              <span class="similarity-badge" [ngClass]="getSimilarityClass(source.similarity_score)">
                {{ getSimilarityLabel(source.similarity_score) }} ({{ source.similarity_score | number:'1.2-2' }})
              </span>
            </div>
            <div class="source-excerpt">
              {{ getSourceExcerpt(source) }}
            </div>
          </div>
        </div>
      </div>

      <!-- Help Text -->
      <div class="research-help" *ngIf="researchChatHistory.length > 0">
        <p class="hint">
          <strong>üí° Tip:</strong> Ask follow-up questions to explore specific aspects, request examples, or dig deeper into any insight.
        </p>
      </div>
    </div>

    <!-- Chat Input (Fixed at bottom) -->
    <div class="research-input-container" *ngIf="researchChatHistory.length > 0">
      <textarea
        class="research-input"
        [(ngModel)]="researchFollowUpInput"
        (keypress)="onResearchKeyPress($event)"
        placeholder="Ask a follow-up question..."
        rows="2"
        [disabled]="researchLoading"></textarea>
      <button
        class="send-button"
        (click)="sendResearchFollowUp()"
        [disabled]="!researchFollowUpInput.trim() || researchLoading">
        <span *ngIf="!researchLoading">Send</span>
        <span *ngIf="researchLoading">‚è≥</span>
      </button>
    </div>
  </div>

  <!-- Feedback Sidebar -->
  <div class="feedback-sidebar-container" *ngIf="showFeedbackSidebar && story && feedbackSidebarConfig" [class.show]="showFeedbackSidebar">
    <div class="sidebar-header">
      <h3>üí¨ Feedback Manager</h3>
      <button class="close-button" (click)="closeFeedbackSidebar()" title="Close">‚úï</button>
    </div>
    
    <div class="sidebar-content">
      <app-feedback-sidebar
        [config]="feedbackSidebarConfig"
        [story]="story"
        [disabled]="false"
        (selectionChanged)="onFeedbackSelectionChanged($event)"
        (feedbackRequested)="onFeedbackRequested($event)"
        (addToChat)="onAddToChat($event)">
      </app-feedback-sidebar>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading" *ngIf="loading">
  <p>Loading story...</p>
</div>

<!-- Error State -->
<div class="error" *ngIf="error">
  <p>{{ error }}</p>
  <a href="/dashboard">Return to Dashboard</a>
</div>
