<!-- Global Loading Spinner -->
<app-loading-spinner></app-loading-spinner>

<!-- Toast Notifications -->
<app-toast></app-toast>

<div class="story-workspace" *ngIf="!loading && !error && story">
  <!-- Header with Story Title and Last Saved -->
  <div class="workspace-header">
    <h1>{{ story.general.title }}</h1>
    <div class="save-indicator" *ngIf="lastSaved">
      Last saved: {{ lastSaved | date:'short' }}
    </div>
  </div>

  <!-- Token Validation Status -->
  <div class="validation-status" *ngIf="activeTab === 'general'">
    <div class="validation-summary" 
         [class.loading]="tokenLimitsLoading || isTokenLimitsRetrying"
         [class.error]="tokenLimitsError && !isTokenLimitsFallbackMode"
         [class.fallback]="isTokenLimitsFallbackMode"
         [class.invalid]="!canSave() && !tokenLimitsLoading && !isTokenLimitsRetrying">
      <span class="status-icon">
        <span *ngIf="tokenLimitsLoading || isTokenLimitsRetrying">‚è≥</span>
        <span *ngIf="tokenLimitsError && !isTokenLimitsFallbackMode">‚ö†Ô∏è</span>
        <span *ngIf="isTokenLimitsFallbackMode">üìä</span>
        <span *ngIf="!canSave() && !tokenLimitsLoading && !isTokenLimitsRetrying && !tokenLimitsError">üö´</span>
        <span *ngIf="canSave() && !tokenLimitsLoading && !isTokenLimitsRetrying && !tokenLimitsError && !isTokenLimitsFallbackMode">‚úÖ</span>
      </span>
      <span class="status-text">{{ getValidationSummary() }}</span>
      
      <!-- Retry Button -->
      <button 
        *ngIf="canRetryTokenLimits()"
        type="button"
        class="retry-button"
        (click)="retryTokenLimits()"
        [disabled]="isTokenLimitsRetrying"
        aria-label="Retry loading token limits">
        <span *ngIf="!isTokenLimitsRetrying">üîÑ Retry</span>
        <span *ngIf="isTokenLimitsRetrying">‚è≥ Retrying...</span>
      </button>
    </div>
    
    <div class="validation-warning" *ngIf="!canSave() && !tokenLimitsLoading && !isTokenLimitsRetrying">
      <strong>Warning:</strong> Some fields exceed token limits. Auto-save is disabled until limits are met.
    </div>
    
    <div class="validation-fallback" *ngIf="isTokenLimitsFallbackMode">
      <strong>Info:</strong> Using default token limits. The app remains functional with estimated token counts.
    </div>
  </div>

  <!-- Tab Navigation -->
  <nav class="tab-nav">
    <button class="tab-button" [class.active]="activeTab === 'general'" (click)="selectTab('general')">General</button>
    <button class="tab-button" [class.active]="activeTab === 'worldbuilding'" (click)="selectTab('worldbuilding')">Worldbuilding</button>
    <button class="tab-button" [class.active]="activeTab === 'characters'" (click)="selectTab('characters')">Characters</button>
    <button class="tab-button" [class.active]="activeTab === 'raters'" (click)="selectTab('raters')">Raters</button>
    <button class="tab-button" [class.active]="activeTab === 'plot-outline'" (click)="selectTab('plot-outline')">Story Outline</button>
    <button class="tab-button" [class.active]="activeTab === 'story'" (click)="selectTab('story')">Story</button>
  </nav>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- General Tab -->
    <div *ngIf="activeTab === 'general'" class="tab-pane general-tab">
      <h2>General Settings</h2>

      <div class="form-section">
        <label for="story-title">Story Title</label>
        <input id="story-title" type="text" [(ngModel)]="story.general.title" placeholder="Enter story title">
      </div>

      <div class="form-section">
        <app-system-prompt-field
          fieldType="mainPrefix"
          label="Main System Prompt Prefix (optional)"
          placeholder="Text added before every agent prompt"
          [rows]="3"
          [(ngModel)]="story.general.systemPrompts.mainPrefix"
          (validationChange)="onFieldValidationChange('mainPrefix', $event)">
        </app-system-prompt-field>
        <div class="file-upload-section">
          <input type="file" #prefixFileInput accept=".txt,.md" (change)="loadFileContent($event, 'prefix')" style="display: none">
          <button class="secondary-button" (click)="prefixFileInput.click()">Load from File (.txt, .md)</button>
        </div>
      </div>

      <div class="form-section">
        <app-system-prompt-field
          fieldType="mainSuffix"
          label="Main System Prompt Suffix (optional)"
          placeholder="Text added after every agent prompt"
          [rows]="3"
          [(ngModel)]="story.general.systemPrompts.mainSuffix"
          (validationChange)="onFieldValidationChange('mainSuffix', $event)">
        </app-system-prompt-field>
        <div class="file-upload-section">
          <input type="file" #suffixFileInput accept=".txt,.md" (change)="loadFileContent($event, 'suffix')" style="display: none">
          <button class="secondary-button" (click)="suffixFileInput.click()">Load from File (.txt, .md)</button>
        </div>
      </div>

      <div class="form-section">
        <app-system-prompt-field
          fieldType="assistantPrompt"
          label="Writer Assistant System Prompt"
          placeholder="Assistant's system prompt configuration"
          [rows]="5"
          [(ngModel)]="story.general.systemPrompts.assistantPrompt"
          (validationChange)="onFieldValidationChange('assistantPrompt', $event)">
        </app-system-prompt-field>
      </div>

      <div class="form-section">
        <app-system-prompt-field
          fieldType="editorPrompt"
          label="Editor System Prompt"
          placeholder="Editor's system prompt configuration"
          [rows]="5"
          [(ngModel)]="story.general.systemPrompts.editorPrompt"
          (validationChange)="onFieldValidationChange('editorPrompt', $event)">
        </app-system-prompt-field>
      </div>
    </div>

    <!-- Worldbuilding Tab -->
    <div *ngIf="activeTab === 'worldbuilding'" class="tab-pane worldbuilding-tab-pane">
      <app-worldbuilding-tab
        [story]="story"
        [disabled]="loading"
        (storyUpdated)="onStoryUpdated($event)">
      </app-worldbuilding-tab>
    </div>

    <!-- Characters Tab -->
    <div *ngIf="activeTab === 'characters'" class="tab-pane characters-tab">
      <h2>Characters</h2>

      <div class="split-panel">
        <!-- Character List -->
        <div class="list-panel">
          <div class="section-header">
            <h3>Active Characters</h3>
            <button class="primary-button" (click)="addCharacter()">+ Add</button>
          </div>

          <div class="character-list">
            <div *ngFor="let character of activeCharacters"
                 class="list-item"
                 [class.selected]="selectedCharacterId === character.id"
                 (click)="selectCharacter(character.id)"
                 (keyup.enter)="selectCharacter(character.id)"
                 (keyup.space)="selectCharacter(character.id)"
                 tabindex="0">
              <div class="item-name">{{ character.name || 'Unnamed' }}</div>
              <div class="item-actions">
                <button class="icon-button" (click)="hideCharacter(character.id); $event.stopPropagation()" title="Hide">üëÅÔ∏è</button>
              </div>
            </div>
          </div>

          <div class="section-header" *ngIf="hiddenCharacters.length > 0">
            <h3>Hidden Characters</h3>
          </div>

          <div class="character-list" *ngIf="hiddenCharacters.length > 0">
            <div *ngFor="let character of hiddenCharacters" class="list-item hidden">
              <div class="item-name">{{ character.name || 'Unnamed' }}</div>
              <div class="item-actions">
                <button class="icon-button" (click)="unhideCharacter(character.id)" title="Unhide">üëÅÔ∏è‚Äçüó®Ô∏è</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Character Details -->
        <div class="detail-panel" *ngIf="editingCharacter">
          <h3>Character Details</h3>

          <div class="form-section">
            <label for="character-basic-bio">Basic Bio (user-provided)</label>
            <textarea id="character-basic-bio" [(ngModel)]="editingCharacter.basicBio" placeholder="A curious journalist who..." rows="4"></textarea>
            <div class="button-group">
              <button class="secondary-button" (click)="generateCharacterDetails()" [disabled]="isGenerateCharacterDetailsDisabled">Generate from Bio</button>
              <button class="secondary-button" (click)="regenerateBio()">Regenerate Bio</button>
            </div>
          </div>

          <div class="form-section">
            <label for="character-name">Name</label>
            <input type="text" id="character-name" [(ngModel)]="editingCharacter.name" placeholder="Character name">
          </div>

          <div class="form-row">
            <div class="form-section">
              <label for="character-sex">Sex</label>
              <input type="text" id="character-sex" [(ngModel)]="editingCharacter.sex" placeholder="Male/Female">
            </div>
            <div class="form-section">
              <label for="character-gender">Gender</label>
              <input type="text" id="character-gender" [(ngModel)]="editingCharacter.gender" placeholder="Gender identity">
            </div>
          </div>

          <div class="form-row">
            <div class="form-section">
              <label for="character-sexual-preference">Sexual Preference</label>
              <input type="text" id="character-sexual-preference" [(ngModel)]="editingCharacter.sexualPreference">
            </div>
            <div class="form-section">
              <label for="character-age">Age</label>
              <input type="number" id="character-age" [(ngModel)]="editingCharacter.age">
            </div>
          </div>

          <div class="form-section">
            <label for="character-physical-appearance">Physical Appearance</label>
            <textarea id="character-physical-appearance" [(ngModel)]="editingCharacter.physicalAppearance" rows="3"></textarea>
          </div>

          <div class="form-section">
            <label for="character-usual-clothing">Usual Clothing</label>
            <textarea id="character-usual-clothing" [(ngModel)]="editingCharacter.usualClothing" rows="2"></textarea>
          </div>

          <div class="form-section">
            <label for="character-personality">Personality</label>
            <textarea id="character-personality" [(ngModel)]="editingCharacter.personality" rows="3"></textarea>
          </div>

          <div class="form-section">
            <label for="character-motivations">Motivations</label>
            <textarea id="character-motivations" [(ngModel)]="editingCharacter.motivations" rows="3"></textarea>
          </div>

          <div class="form-section">
            <label for="character-fears">Fears</label>
            <textarea id="character-fears" [(ngModel)]="editingCharacter.fears" rows="3"></textarea>
          </div>

          <div class="form-section">
            <label for="character-relationships">Relationships</label>
            <textarea id="character-relationships" [(ngModel)]="editingCharacter.relationships" rows="4"></textarea>
            <button class="secondary-button" (click)="regenerateRelationships()">Regenerate Relationships</button>
          </div>

          <div class="button-group">
            <button class="primary-button" (click)="saveCharacter()">Save</button>
            <button class="danger-button" (click)="removeCharacter(editingCharacter.id)">Delete</button>
          </div>
        </div>

        <div class="detail-panel empty" *ngIf="!editingCharacter">
          <p>Select a character to edit or add a new one.</p>
        </div>
      </div>
    </div>

    <!-- Raters Tab -->
    <div *ngIf="activeTab === 'raters'" class="tab-pane raters-tab">
      <h2>Raters</h2>

      <div class="split-panel">
        <!-- Rater List -->
        <div class="list-panel">
          <div class="section-header">
            <h3>Configured Raters</h3>
            <button class="primary-button" (click)="addRater()">+ Add New Rater</button>
          </div>

          <div class="rater-list">
            <div *ngFor="let rater of ratersArray"
                 class="list-item"
                 [class.selected]="selectedRaterId === rater.id"
                 (click)="selectRater(rater.id)"
                 (keyup.enter)="selectRater(rater.id)"
                 (keyup.space)="selectRater(rater.id)"
                 tabindex="0">
              <div class="item-name">{{ rater.name || 'Unnamed Rater' }}</div>
              <div class="item-actions">
                <label class="toggle">
                  <input type="checkbox" [checked]="rater.enabled" (change)="toggleRater(rater.id); $event.stopPropagation()">
                  <span>Enabled</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Rater Details -->
        <div class="detail-panel" *ngIf="editingRater">
          <h3>Rater Configuration</h3>

          <div class="form-section">
            <label for="rater-name">Name</label>
            <input type="text" id="rater-name" [(ngModel)]="editingRater.name" placeholder="e.g., Character Consistency Rater">
          </div>

          <div class="form-section">
            <app-system-prompt-field
              fieldType="raterSystemPrompt"
              label="System Prompt"
              placeholder="Evaluate character consistency, check for..."
              [rows]="10"
              [(ngModel)]="editingRater.systemPrompt"
              (validationChange)="onRaterFieldValidationChange($event)">
            </app-system-prompt-field>
            <div class="file-upload-section">
              <input type="file" #raterFileInput accept=".txt,.md" (change)="loadFileContent($event, 'rater')" style="display: none">
              <button class="secondary-button" (click)="raterFileInput.click()">Load from File (.txt, .md)</button>
            </div>
          </div>

          <div class="button-group">
            <button class="primary-button" (click)="saveRater()">Save</button>
            <button class="danger-button" (click)="removeRater(editingRater.id)">Delete</button>
          </div>
        </div>

        <div class="detail-panel empty" *ngIf="!editingRater">
          <p>Select a rater to edit or add a new one.</p>
        </div>
      </div>
    </div>

    <!-- Plot Outline Tab -->
    <div *ngIf="activeTab === 'plot-outline'" class="tab-pane plot-outline-tab">
      <app-plot-outline-tab
        [story]="story"
        [disabled]="loading"
        (outlineUpdated)="onPlotOutlineUpdated($event)"
        (outlineApproved)="onPlotOutlineApproved()"
        (chapterEdit)="editChapter($event)">
      </app-plot-outline-tab>
    </div>

    <!-- Story Tab -->
    <div *ngIf="activeTab === 'story'" class="tab-pane story-tab">
      <h2>Story</h2>

      <div class="story-summary">
        <h3>Overall Story Summary</h3>
        <div class="summary-content">
          <p>{{ story.story.summary || 'No summary yet. Generate chapters to create a summary.' }}</p>
        </div>
        <button class="secondary-button" (click)="regenerateSummary()">Regenerate Summary</button>
      </div>

      <div class="chapters-section">
        <div class="section-header">
          <h3>Chapters</h3>
        </div>

        <div class="chapters-list">
          <div *ngFor="let chapter of story.story.chapters; let i = index" class="chapter-item">
            <div class="chapter-header">
              <h4>Chapter {{ chapter.number }}: {{ chapter.title }}</h4>
              <div class="chapter-actions">
                <button class="primary-button" (click)="editChapter(chapter)" title="Edit chapter">
                  <mat-icon>edit</mat-icon>
                  Edit
                </button>
                <button class="danger-button" (click)="deleteChapter(chapter.id)">Delete</button>
              </div>
            </div>
            <div class="chapter-preview">
              <p>{{ chapter.content.substring(0, 200) }}...</p>
              <div class="chapter-meta">
                Word count: {{ chapter.metadata.wordCount }} | Last modified: {{ chapter.metadata.lastModified | date:'short' }}
              </div>
            </div>
          </div>

          <div *ngIf="story.story.chapters.length === 0" class="empty-state">
            <p>No chapters yet. Create your first chapter in the Chapter Creation tab!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Research Archive Sidebar -->
  <div class="research-sidebar" *ngIf="showResearchSidebar" [class.show]="showResearchSidebar">
    <div class="sidebar-header">
      <h3>üìö Archive Research</h3>
      <div class="header-actions">
        <button class="icon-button-header" (click)="clearResearchChat()" *ngIf="researchChatHistory.length > 0" title="Clear conversation">üóëÔ∏è</button>
        <button class="close-button" (click)="closeResearchSidebar()" title="Close">‚úï</button>
      </div>
    </div>

    <div class="sidebar-content">
      <!-- Initial Loading State -->
      <div class="research-loading" *ngIf="researchLoading && researchChatHistory.length === 0">
        <div class="spinner"></div>
        <p>Researching your story archive...</p>
      </div>

      <!-- Error State (when no conversation yet) -->
      <div class="research-error" *ngIf="researchError && researchChatHistory.length === 0">
        <span class="error-icon">‚ö†Ô∏è</span>
        <p>{{ researchError }}</p>
      </div>

      <!-- Chat History -->
      <div class="research-chat-history" *ngIf="researchChatHistory.length > 0">
        <div *ngFor="let message of researchChatHistory; let i = index"
             class="chat-message"
             [ngClass]="'chat-message-' + message.role">

          <!-- User Message -->
          <div *ngIf="message.role === 'user'" class="message-bubble user-bubble">
            <div class="message-label">You asked:</div>
            <div class="message-text">{{ message.content }}</div>
          </div>

          <!-- Assistant Message -->
          <div *ngIf="message.role === 'assistant'" class="message-bubble assistant-bubble">
            <div class="message-label">Research Assistant:</div>
            <div class="message-text" [innerHTML]="message.content | newlineToBr"></div>

            <!-- Sources for this response -->
            <div class="message-sources" *ngIf="message.sources && message.sources.length > 0">
              <div class="sources-toggle" (click)="message.showSources = !message.showSources" (keyup.enter)="message.showSources = !message.showSources" (keyup.space)="message.showSources = !message.showSources" tabindex="0">
                <span>üìñ {{ message.sources.length }} sources</span>
                <span class="toggle-icon">{{ message.showSources ? '‚ñº' : '‚ñ∂' }}</span>
              </div>
              <div class="sources-list" *ngIf="message.showSources">
                <div class="source-item-compact" *ngFor="let source of message.sources">
                  <span class="source-file-compact">{{ getSourceFileName(source) }}</span>
                  <span class="similarity-badge-compact" [ngClass]="getSimilarityClass(source.similarity_score)">
                    {{ source.similarity_score | number:'1.2-2' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Typing Indicator -->
        <div class="chat-message chat-message-assistant" *ngIf="researchLoading">
          <div class="message-bubble assistant-bubble typing-bubble">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>

        <!-- Error in conversation -->
        <div class="inline-error" *ngIf="researchError && researchChatHistory.length > 0">
          <span class="error-icon">‚ö†Ô∏è</span>
          <span>{{ researchError }}</span>
        </div>
      </div>

      <!-- Latest Sources Panel (expanded view) -->
      <div class="research-sources-panel" *ngIf="researchData && researchData.sources && researchData.sources.length > 0">
        <h4>üìñ Latest Sources</h4>
        <div class="sources-list-detailed">
          <div class="source-item" *ngFor="let source of researchData.sources">
            <div class="source-header">
              <span class="source-file">{{ getSourceFileName(source) }}</span>
              <span class="similarity-badge" [ngClass]="getSimilarityClass(source.similarity_score)">
                {{ getSimilarityLabel(source.similarity_score) }} ({{ source.similarity_score | number:'1.2-2' }})
              </span>
            </div>
            <div class="source-excerpt">
              {{ getSourceExcerpt(source) }}
            </div>
          </div>
        </div>
      </div>

      <!-- Help Text -->
      <div class="research-help" *ngIf="researchChatHistory.length > 0">
        <p class="hint">
          <strong>üí° Tip:</strong> Ask follow-up questions to explore specific aspects, request examples, or dig deeper into any insight.
        </p>
      </div>
    </div>

    <!-- Chat Input (Fixed at bottom) -->
    <div class="research-input-container" *ngIf="researchChatHistory.length > 0">
      <textarea
        class="research-input"
        [(ngModel)]="researchFollowUpInput"
        (keypress)="onResearchKeyPress($event)"
        placeholder="Ask a follow-up question..."
        rows="2"
        [disabled]="researchLoading"></textarea>
      <button
        class="send-button"
        (click)="sendResearchFollowUp()"
        [disabled]="!researchFollowUpInput.trim() || researchLoading">
        <span *ngIf="!researchLoading">Send</span>
        <span *ngIf="researchLoading">‚è≥</span>
      </button>
    </div>
  </div>

</div>

<!-- Loading State -->
<div class="loading" *ngIf="loading">
  <p>Loading story...</p>
</div>

<!-- Chapter Editor Modal -->
<div class="chapter-editor-overlay" *ngIf="isEditingChapter && currentEditingChapter && story">
  <app-chapter-editor
    [chapter]="currentEditingChapter"
    [story]="story"
    (backToList)="onBackFromChapterEditor()"
    (saveChapter)="onSaveChapter($event)"
    class="chapter-editor-modal">
  </app-chapter-editor>
</div>

<!-- Error State -->
<div class="error" *ngIf="error">
  <p>{{ error }}</p>
  <a href="/dashboard">Return to Dashboard</a>
</div>
