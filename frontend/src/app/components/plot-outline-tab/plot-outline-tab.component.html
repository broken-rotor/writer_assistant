<!-- plot-outline-tab.component.html -->
<div class="plot-outline-tab">
  <!-- Main Content Area -->
  <div class="main-content" [class.with-chat]="showChat">
    
    <!-- Left Panel: Outline Editor -->
    <div class="outline-panel">
      <h3>Overall Story Outline</h3>
      <textarea 
        [(ngModel)]="story.plotOutline.content"
        (ngModelChange)="onOutlineChange()"
        placeholder="Act I: Setup&#10;- Character introduction&#10;- Inciting incident&#10;&#10;Act II: Rising Action&#10;- Conflict development&#10;- Complications&#10;&#10;Act III: Resolution&#10;- Climax&#10;- Resolution"
        rows="20"
        class="outline-editor"
        [disabled]="disabled">
      </textarea>
      
      <div class="outline-actions">
        <button 
          class="secondary-button" 
          (click)="aiExpandOutline()" 
          [disabled]="isGeneratingAI || disabled">
          <span *ngIf="!isGeneratingAI">ğŸ¤– AI Expand</span>
          <span *ngIf="isGeneratingAI">â³ Generating...</span>
        </button>
        
        <button 
          class="secondary-button" 
          (click)="researchOutline()" 
          [disabled]="isResearching || disabled"
          title="Research similar content from story archive">
          <span *ngIf="!isResearching">ğŸ“š Research</span>
          <span *ngIf="isResearching">â³ Researching...</span>
        </button>
        
        <button class="secondary-button" (click)="saveOutline()" [disabled]="disabled">ğŸ’¾ Save</button>
        <button class="secondary-button" (click)="resetOutline()" [disabled]="disabled">ğŸ”„ Reset</button>
      </div>
      
      <div class="outline-status">
        Status: <span class="status-badge status-{{story.plotOutline.status}}">
          {{ getStatusDisplay() }}
        </span>
      </div>
    </div>

    <!-- Right Panel: AI Chat Assistant -->
    <div class="chat-panel" *ngIf="showChat">
      <h3>ğŸ’¬ AI Chat Assistant</h3>
      
      <div class="chat-messages" #chatMessages>
        <div *ngFor="let message of story.plotOutline.chatHistory" 
             class="chat-message"
             [class.user-message]="message.type === 'user'"
             [class.ai-message]="message.type === 'assistant'">
          <div class="message-content">{{ message.content }}</div>
          <div class="message-timestamp">{{ message.timestamp | date:'short' }}</div>
        </div>
        
        <div *ngIf="isChatGenerating" class="chat-message ai-message generating">
          <div class="message-content">
            <span class="typing-indicator">AI is thinking...</span>
          </div>
        </div>
        
        <div *ngIf="story.plotOutline.chatHistory.length === 0 && !isChatGenerating" class="empty-chat">
          Start a conversation about your story outline...
        </div>
      </div>
      
      <div class="chat-error" *ngIf="chatError">
        <span class="error-message">{{ chatError }}</span>
        <button class="retry-button" (click)="chatError = null">âœ•</button>
      </div>
      
      <div class="chat-input-area">
        <textarea 
          [(ngModel)]="chatInput"
          placeholder="Type your message..."
          rows="3"
          class="chat-input"
          [disabled]="disabled || isChatGenerating"
          (keydown.ctrl.enter)="sendChatMessage()"
          (keydown.meta.enter)="sendChatMessage()">
        </textarea>
        <div class="chat-actions">
          <button 
            class="primary-button" 
            (click)="sendChatMessage()" 
            [disabled]="!chatInput.trim() || disabled || isChatGenerating">
            <span *ngIf="!isChatGenerating">Send</span>
            <span *ngIf="isChatGenerating">â³ Sending...</span>
          </button>
          <button 
            class="secondary-button" 
            (click)="clearChat()" 
            [disabled]="disabled || story.plotOutline.chatHistory.length === 0">
            Clear Chat
          </button>
        </div>
        <div class="chat-hint">
          <small>Tip: Press Ctrl+Enter (Cmd+Enter on Mac) to send</small>
        </div>
      </div>
      
      <div class="quick-actions">
        <h4>Quick Actions</h4>
        <div class="quick-action-buttons">
          <button class="quick-action-btn" (click)="suggestPlotStructure()" [disabled]="disabled || isChatGenerating">
            ğŸ“‹ Suggest Structure
          </button>
          <button class="quick-action-btn" (click)="identifyPlotHoles()" [disabled]="disabled || isChatGenerating">
            ğŸ” Find Plot Holes
          </button>
          <button class="quick-action-btn" (click)="generateCharacterArcs()" [disabled]="disabled || isChatGenerating">
            ğŸ‘¥ Character Arcs
          </button>
          <button class="quick-action-btn" (click)="checkPacing()" [disabled]="disabled || isChatGenerating">
            â±ï¸ Check Pacing
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Rater Feedback Section -->
  <div class="rater-feedback-section">
    <div class="feedback-header">
      <h3>ğŸ“ Rater Feedback Section</h3>
      <div class="feedback-actions">
        <button 
          class="primary-button" 
          (click)="requestAllRaterFeedback()" 
          [disabled]="disabled || generatingFeedback.size > 0">
          ğŸ¯ Request All Feedback
        </button>
        <button 
          class="secondary-button" 
          (click)="regenerateAllFeedback()" 
          [disabled]="disabled || generatingFeedback.size > 0">
          ğŸ”„ Regenerate All
        </button>
        <button 
          class="secondary-button" 
          (click)="clearAllFeedback()" 
          [disabled]="disabled">
          âŒ Clear All
        </button>
      </div>
    </div>

    <div class="feedback-error" *ngIf="feedbackError">
      <span class="error-message">{{ feedbackError }}</span>
      <button class="retry-button" (click)="feedbackError = null">âœ•</button>
    </div>

    <div class="rater-feedback-list">
      <div *ngFor="let rater of getEnabledRaters()" class="rater-feedback-card">
        <div class="rater-header">
          <h4>{{ rater.name }}</h4>
          <div class="rater-status">
            <span *ngIf="!hasRaterFeedback(rater.id)" class="status-badge status-pending">
              â¸ï¸ Pending
            </span>
            <span *ngIf="generatingFeedback.has(rater.id)" class="status-badge status-generating">
              â³ Generating...
            </span>
            <span *ngIf="getRaterFeedback(rater.id)?.status === 'complete'" 
                  class="status-badge status-complete">
              âœ… Complete
            </span>
            <span *ngIf="getRaterFeedback(rater.id)?.status === 'error'" 
                  class="status-badge status-error">
              âŒ Error
            </span>
          </div>
        </div>

        <div class="rater-feedback-content" 
             *ngIf="getRaterFeedback(rater.id)?.status === 'complete'">
          <div class="feedback-text">
            {{ getRaterFeedback(rater.id)?.feedback }}
          </div>
          <div class="feedback-actions">
            <button 
              class="feedback-action-btn accept" 
              (click)="acceptFeedback(rater.id)"
              [class.selected]="getRaterFeedback(rater.id)?.userResponse === 'accepted'">
              ğŸ‘ Accept
            </button>
            <button 
              class="feedback-action-btn revision" 
              (click)="requestRevision(rater.id)"
              [disabled]="generatingFeedback.has(rater.id)">
              ğŸ”„ Request Revision
            </button>
            <button 
              class="feedback-action-btn discuss" 
              (click)="discussFeedback(rater.id)">
              ğŸ’¬ Discuss Further
            </button>
          </div>
        </div>

        <div class="rater-feedback-content" 
             *ngIf="getRaterFeedback(rater.id)?.status === 'error'">
          <div class="error-message">
            Failed to generate feedback. Please try again.
          </div>
          <div class="feedback-actions">
            <button 
              class="feedback-action-btn retry" 
              (click)="requestRaterFeedback(rater.id)"
              [disabled]="generatingFeedback.has(rater.id)">
              ğŸ”„ Retry
            </button>
            <button 
              class="feedback-action-btn skip" 
              (click)="deleteRaterFeedback(rater.id)">
              âŒ Skip
            </button>
          </div>
        </div>

        <div class="rater-feedback-content" 
             *ngIf="!hasRaterFeedback(rater.id) && !generatingFeedback.has(rater.id)">
          <button 
            class="request-feedback-btn" 
            (click)="requestRaterFeedback(rater.id)"
            [disabled]="disabled">
            ğŸ“ Request Feedback from {{ rater.name }}
          </button>
        </div>
      </div>

      <div *ngIf="getEnabledRaters().length === 0" class="no-raters">
        <p>No enabled raters found. Please enable raters in the <strong>Raters</strong> tab to get feedback on your story outline.</p>
      </div>
    </div>

    <div class="feedback-summary">
      <div class="progress-info">
        Progress: {{ getFeedbackProgress().completed }}/{{ getFeedbackProgress().total }} raters complete
      </div>
      <button 
        class="approve-button" 
        (click)="approveOutline()" 
        [disabled]="!canApproveOutline() || disabled"
        [class.ready]="canApproveOutline()">
        <span *ngIf="canApproveOutline()">âœ… Approve Story Outline</span>
        <span *ngIf="!canApproveOutline()">â³ Waiting for feedback...</span>
      </button>
    </div>
  </div>
</div>
