<div class="archive">
  <header class="archive-header">
    <h2>Story Archive</h2>
    <p class="archive-description">
      Search through your archived stories using semantic search or ask questions with AI
    </p>

    <!-- Mode Switcher -->
    <div class="mode-switcher">
      <button
        class="mode-btn"
        [class.active]="mode === 'search'"
        (click)="switchMode('search')"
      >
        üîç Search
      </button>
      <button
        class="mode-btn"
        [class.active]="mode === 'chat'"
        (click)="switchMode('chat')"
        [disabled]="!isRagEnabled()"
        [title]="!isRagEnabled() ? getRagStatusMessage() : 'Ask questions about your stories'"
      >
        üí¨ Chat (RAG)
      </button>
    </div>
  </header>

  <!-- Archive Stats -->
  <div class="archive-stats" *ngIf="stats">
    <div class="stat-item">
      <span class="stat-icon">üìö</span>
      <div class="stat-info">
        <span class="stat-value">{{ stats.total_files }}</span>
        <span class="stat-label">Files</span>
      </div>
    </div>
    <div class="stat-item">
      <span class="stat-icon">üìÑ</span>
      <div class="stat-info">
        <span class="stat-value">{{ stats.total_chunks }}</span>
        <span class="stat-label">Sections</span>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="error && !isSearching">
    <span class="error-icon">‚ö†Ô∏è</span>
    <span>{{ error }}</span>
  </div>

  <!-- Search Section -->
  <div class="search-section" *ngIf="mode === 'search'">
    <div class="search-box">
      <input
        type="text"
        class="search-input"
        placeholder="Search for themes, characters, scenes, or any topic..."
        [(ngModel)]="searchQuery"
        (keypress)="onSearchKeyPress($event)"
        [disabled]="isSearching"
      />
      <button
        class="btn-primary search-btn"
        (click)="onSearch()"
        [disabled]="!searchQuery.trim() || isSearching"
      >
        <span class="icon" *ngIf="!isSearching">üîç</span>
        <span *ngIf="isSearching">Searching...</span>
        <span *ngIf="!isSearching">Search</span>
      </button>
      <button
        class="btn-secondary"
        (click)="clearSearch()"
        *ngIf="hasSearched"
      >
        Clear
      </button>
    </div>

    <!-- Advanced Options -->
    <div class="advanced-options">
      <button class="btn-link" (click)="toggleAdvancedOptions()">
        <span *ngIf="!showAdvancedOptions">‚ñ∂ Advanced Options</span>
        <span *ngIf="showAdvancedOptions">‚ñº Advanced Options</span>
      </button>

      <div class="options-panel" *ngIf="showAdvancedOptions">
        <div class="option-group">
          <label for="maxResults">Maximum Results:</label>
          <input
            type="number"
            id="maxResults"
            [(ngModel)]="maxResults"
            min="1"
            max="50"
            class="option-input"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Section -->
  <div class="chat-section" *ngIf="mode === 'chat'">
    <!-- RAG Status Message -->
    <div class="info-message" *ngIf="!isRagEnabled()">
      <span class="info-icon">‚ÑπÔ∏è</span>
      <span>{{ getRagStatusMessage() }}</span>
    </div>

    <!-- Chat Error Message -->
    <div class="error-message" *ngIf="chatError && !isChatProcessing">
      <span class="error-icon">‚ö†Ô∏è</span>
      <span>{{ chatError }}</span>
    </div>

    <!-- Chat Container with Sidebar -->
    <div class="chat-container" *ngIf="isRagEnabled()">
      <div class="chat-main">
        <!-- Chat Messages -->
        <div class="chat-messages">
          <div class="chat-welcome" *ngIf="chatMessages.length === 0">
            <h3>Ask Questions About Your Stories</h3>
            <p>Use natural language to query your story archive. Examples:</p>
            <ul class="example-queries">
              <li>"What themes appear most frequently in my stories?"</li>
              <li>"Tell me about the character development in story X"</li>
              <li>"What are the main conflicts in my fantasy stories?"</li>
              <li>"Summarize the plot of story Y"</li>
            </ul>
          </div>

          <div
            class="message"
            *ngFor="let message of chatMessages; let i = index"
            [ngClass]="{
              'message-user': message.role === 'user',
              'message-assistant': message.role === 'assistant',
              'message-selected': isMessageSelected(i)
            }"
            (click)="selectMessage(i)"
            [style.cursor]="message.role === 'assistant' && message.sources ? 'pointer' : 'default'"
          >
            <div class="message-avatar">
              <span *ngIf="message.role === 'user'">üë§</span>
              <span *ngIf="message.role === 'assistant'">ü§ñ</span>
            </div>
            <div class="message-content">
              <div class="message-text" [innerHTML]="parseMarkdown(message.content)"></div>
            </div>
          </div>

          <!-- Processing Indicator -->
          <div class="message message-assistant" *ngIf="isChatProcessing">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
              <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-container">
          <textarea
            class="chat-input"
            placeholder="Ask a question about your stories..."
            [(ngModel)]="chatInput"
            (keypress)="onChatKeyPress($event)"
            [disabled]="isChatProcessing"
            rows="2"
          ></textarea>
          <div class="chat-actions">
            <button
              class="btn-secondary btn-sm"
              (click)="clearChat()"
              *ngIf="chatMessages.length > 0"
              [disabled]="isChatProcessing"
            >
              Clear Chat
            </button>
            <button
              class="btn-primary"
              (click)="sendChatMessage()"
              [disabled]="!chatInput.trim() || isChatProcessing"
            >
              <span *ngIf="!isChatProcessing">Send</span>
              <span *ngIf="isChatProcessing">Processing...</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Sources Sidebar -->
      <div class="chat-sidebar" *ngIf="chatMessages.length > 0">
        <div class="sidebar-header">
          <h4>üìö Sources</h4>
          <p class="sidebar-hint" *ngIf="currentChatSources.length === 0">
            Click on a response to view its sources
          </p>
        </div>
        <div class="source-list" *ngIf="currentChatSources.length > 0">
          <div class="source-item" *ngFor="let source of currentChatSources">
            <div class="source-header">
              <span class="source-file">{{ source.file_name }}</span>
              <span class="source-score" [ngClass]="getSimilarityBadgeClass(source.similarity_score)">
                {{ (source.similarity_score * 100).toFixed(0) }}%
              </span>
            </div>
            <div class="source-text">{{ getHighlightedText(source.matching_section, 200) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Results -->
  <div class="results-section" *ngIf="mode === 'search' && hasSearched && !isSearching">
    <div class="results-header">
      <h3>Search Results</h3>
      <span class="results-count" *ngIf="searchResults.length > 0">
        {{ searchResults.length }} result{{ searchResults.length !== 1 ? 's' : '' }} found
      </span>
    </div>

    <div class="results-list" *ngIf="searchResults.length > 0">
      <div class="result-item" *ngFor="let result of searchResults">
        <div class="result-header">
          <div class="result-title">
            <span class="file-icon">üìñ</span>
            <span class="file-name">{{ result.file_name }}</span>
          </div>
          <div class="result-meta">
            <span
              class="similarity-badge"
              [ngClass]="getSimilarityBadgeClass(result.similarity_score)"
              [title]="'Similarity score: ' + result.similarity_score"
            >
              {{ getSimilarityLabel(result.similarity_score) }}
            </span>
          </div>
        </div>

        <div class="result-content">
          <p class="matching-section">
            {{ getHighlightedText(result.matching_section, 400) }}
          </p>
        </div>

        <div class="result-footer">
          <span class="result-path" [title]="result.file_path">
            üìÅ {{ result.file_path }}
          </span>
          <button
            class="btn-secondary btn-sm"
            (click)="viewFileContent(result)"
          >
            View Full File
          </button>
        </div>
      </div>
    </div>

    <div class="no-results" *ngIf="searchResults.length === 0 && !error">
      <div class="no-results-icon">üîç</div>
      <p>No results found for "{{ searchQuery }}"</p>
      <p class="no-results-hint">Try different keywords or broader search terms.</p>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-section" *ngIf="mode === 'search' && isSearching">
    <div class="spinner"></div>
    <p>Searching archive...</p>
  </div>

  <!-- File Content Viewer -->
  <div class="content-viewer" id="content-viewer" *ngIf="selectedFile && fileContent">
    <div class="content-header">
      <h3>{{ selectedFile.file_name }}</h3>
      <button class="btn-close" (click)="closeFileContent()" title="Close">‚úï</button>
    </div>
    <div class="content-path">
      <span class="icon">üìÅ</span>
      {{ selectedFile.file_path }}
    </div>
    <div class="content-body">
      <pre class="content-text">{{ fileContent }}</pre>
    </div>
  </div>

  <!-- Loading Content Spinner -->
  <div class="loading-section" *ngIf="isLoadingContent">
    <div class="spinner"></div>
    <p>Loading file content...</p>
  </div>

  <!-- Help Section -->
  <div class="help-section" *ngIf="mode === 'search' && !hasSearched">
    <h3>How to use Archive Search</h3>
    <ul class="help-list">
      <li>
        <strong>Semantic Search:</strong> Search using natural language queries like
        "stories about redemption" or "scenes with dramatic confrontation"
      </li>
      <li>
        <strong>Relevance:</strong> Results are ranked by semantic similarity, not just
        keyword matching
      </li>
      <li>
        <strong>Context:</strong> Each result shows the relevant section of text along
        with its location in the file
      </li>
      <li>
        <strong>Full Access:</strong> Click "View Full File" to see the complete story
      </li>
    </ul>
  </div>

  <!-- Chat Help Section -->
  <div class="help-section" *ngIf="mode === 'chat' && chatMessages.length === 0 && isRagEnabled()">
    <h3>About RAG (Retrieval-Augmented Generation)</h3>
    <ul class="help-list">
      <li>
        <strong>Natural Questions:</strong> Ask questions in plain English about your stories
      </li>
      <li>
        <strong>Context-Aware:</strong> The AI retrieves relevant sections from your archive
        before answering
      </li>
      <li>
        <strong>Multi-Turn:</strong> Continue the conversation - the AI remembers previous
        questions and answers
      </li>
      <li>
        <strong>Source Transparency:</strong> See exactly which story sections were used
        to generate each answer
      </li>
    </ul>
  </div>
</div>
