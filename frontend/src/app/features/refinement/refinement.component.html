<div class="refinement-container" *ngIf="story">
  <!-- Story Header -->
  <mat-card class="story-header-card">
    <mat-card-header>
      <mat-card-title>{{ story.title }}</mat-card-title>
      <mat-card-subtitle>Refinement Phase - Get feedback and polish your story</mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <!-- Current Content Preview -->
  <mat-card class="content-preview-card">
    <mat-card-header>
      <mat-card-title>Current Story Content</mat-card-title>
      <mat-card-subtitle>{{ getWordCount() }} words • Ready for feedback and refinement</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="content-preview">
        <p>{{ story.finalContent.content | slice:0:500 }}...</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Agent Selection -->
  <mat-card class="agent-selection-card" *ngIf="!showFeedbackResults">
    <mat-card-header>
      <mat-card-title>Select Feedback Agents</mat-card-title>
      <mat-card-subtitle>Choose which agents should review your story</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="agents-grid">
        <mat-card
          class="agent-card"
          *ngFor="let agent of availableAgents"
          [class.selected]="selectedAgents.has(agent.id)">

          <mat-card-header>
            <mat-card-title>
              <mat-checkbox
                [checked]="selectedAgents.has(agent.id)"
                (change)="onAgentSelectionChange(agent.id, $event.checked)">
                {{ agent.name }}
              </mat-checkbox>
            </mat-card-title>
            <mat-card-subtitle>{{ agent.type | titlecase }}</mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <p class="agent-description">{{ agent.description }}</p>
            <div class="focus-areas">
              <span class="focus-label">Focus Areas:</span>
              <mat-chip-list>
                <mat-chip *ngFor="let area of agent.focusAreas">{{ area }}</mat-chip>
              </mat-chip-list>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="generation-actions">
        <button
          mat-raised-button
          color="primary"
          [disabled]="!canGenerateFeedback"
          (click)="onGenerateFeedback()"
          class="generate-feedback-button">
          <mat-icon *ngIf="isGeneratingFeedback">autorenew</mat-icon>
          <span *ngIf="!isGeneratingFeedback">Generate Feedback</span>
          <span *ngIf="isGeneratingFeedback">Generating Feedback...</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Feedback Results -->
  <div class="feedback-results" *ngIf="showFeedbackResults">
    <mat-card class="feedback-summary-card">
      <mat-card-header>
        <mat-card-title>Feedback Summary</mat-card-title>
        <mat-card-subtitle>Review feedback from {{ feedbackData.length }} agents</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="feedback-overview">
          <div class="overview-stats">
            <div class="stat-item">
              <span class="stat-value">{{ selectedFeedback.length }}</span>
              <span class="stat-label">Selected</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ ignoredFeedback.length }}</span>
              <span class="stat-label">Ignored</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ feedbackData.reduce((total, fd) => total + fd.suggestions.length, 0) }}</span>
              <span class="stat-label">Total Suggestions</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Agent Feedback Cards -->
    <div class="feedback-cards">
      <mat-card class="agent-feedback-card" *ngFor="let feedback of feedbackData">
        <mat-card-header>
          <mat-card-title>{{ feedback.agentName }}</mat-card-title>
          <mat-card-subtitle>
            Score: {{ feedback.score }}/10 • Priority: {{ feedback.priority | titlecase }}
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <!-- Strengths -->
          <div class="feedback-section" *ngIf="feedback.strengths.length > 0">
            <h4>Strengths</h4>
            <ul class="strengths-list">
              <li *ngFor="let strength of feedback.strengths">{{ strength }}</li>
            </ul>
          </div>

          <!-- Concerns -->
          <div class="feedback-section" *ngIf="feedback.concerns.length > 0">
            <h4>Concerns</h4>
            <ul class="concerns-list">
              <li *ngFor="let concern of feedback.concerns">{{ concern }}</li>
            </ul>
          </div>

          <!-- Suggestions -->
          <div class="feedback-section" *ngIf="feedback.suggestions.length > 0">
            <h4>Suggestions</h4>
            <div class="suggestions-list">
              <div
                class="suggestion-item"
                *ngFor="let suggestion of feedback.suggestions"
                [class.selected]="getFeedbackSelectionState(suggestion) === 'selected'"
                [class.ignored]="getFeedbackSelectionState(suggestion) === 'ignored'">

                <div class="suggestion-header">
                  <div class="suggestion-info">
                    <span class="suggestion-type">{{ suggestion.type | titlecase }}</span>
                    <span class="suggestion-priority">{{ suggestion.priority }}</span>
                    <span class="actionable-badge" *ngIf="suggestion.actionable">Actionable</span>
                  </div>

                  <div class="suggestion-actions">
                    <button
                      mat-icon-button
                      [color]="getFeedbackSelectionState(suggestion) === 'selected' ? 'primary' : ''"
                      (click)="onToggleFeedbackSelection(suggestion)"
                      matTooltip="Toggle selection">
                      <mat-icon>
                        {{ getFeedbackSelectionState(suggestion) === 'selected' ? 'check_circle' :
                           getFeedbackSelectionState(suggestion) === 'ignored' ? 'cancel' : 'radio_button_unchecked' }}
                      </mat-icon>
                    </button>
                  </div>
                </div>

                <div class="suggestion-content">
                  <p>{{ suggestion.content }}</p>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Apply Feedback Actions -->
    <mat-card class="apply-feedback-card">
      <mat-card-header>
        <mat-card-title>Apply Selected Feedback</mat-card-title>
        <mat-card-subtitle>{{ selectedFeedback.length }} suggestions selected for application</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="selected-feedback-preview" *ngIf="hasSelectedFeedback">
          <h4>Selected Suggestions:</h4>
          <div class="preview-list">
            <div class="preview-item" *ngFor="let item of selectedFeedback">
              <span class="preview-type">{{ item.type | titlecase }}:</span>
              <span class="preview-content">{{ item.content | slice:0:100 }}...</span>
            </div>
          </div>
        </div>

        <div class="apply-actions">
          <button
            mat-raised-button
            color="primary"
            [disabled]="!canApplyFeedback"
            (click)="onApplySelectedFeedback()"
            class="apply-button">
            <mat-icon *ngIf="isApplyingFeedback">autorenew</mat-icon>
            <span *ngIf="!isApplyingFeedback">Apply Selected Feedback</span>
            <span *ngIf="isApplyingFeedback">Applying Feedback...</span>
          </button>

          <button
            mat-button
            (click)="onRequestMoreFeedback()">
            <mat-icon>refresh</mat-icon>
            Request New Feedback
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Final Actions -->
  <div class="final-actions">
    <div class="primary-actions">
      <button
        mat-raised-button
        color="primary"
        (click)="onCompleteStory()">
        <mat-icon>check_circle</mat-icon>
        Complete Story
      </button>
    </div>

    <div class="secondary-actions">
      <button mat-button routerLink="/content-generation/{{story.id}}">
        <mat-icon>arrow_back</mat-icon>
        Back to Content Generation
      </button>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="progress-section">
    <h4>Story Development Progress</h4>
    <mat-progress-bar mode="determinate" [value]="90"></mat-progress-bar>
    <p class="progress-text">Phase 4 of 4: Refinement & Completion</p>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="!story">
  <mat-spinner></mat-spinner>
  <p>Loading story...</p>
</div>